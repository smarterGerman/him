<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SG1 - AI German Learning System</title>
    <style>
        /* ===== BASE STYLES ===== */
        body, html { 
            margin: 0; 
            padding: 0; 
            height: 100%; 
            background: none; 
        }
        
        .sg1-container * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }

        .sg1-container { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 999999;
            background: linear-gradient(-45deg, #4ecdc4, #45b7d1, #96ceb4, #ffecd2);
            background-size: 400% 400%; 
            animation: sg1GradientShift 15s ease infinite;
            overflow: hidden; 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }

        @keyframes sg1GradientShift { 
            0% { background-position: 0% 50%; } 
            50% { background-position: 100% 50%; } 
            100% { background-position: 0% 50%; } 
        }

        /* ===== MUSIC INDICATOR (ALWAYS VISIBLE, WORD ONLY) ===== */
        .music-indicator {
            position: fixed;
            top: 20px;
            right: 30px;
            color: #fff;
            font-size: 16px;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: none;
            border-radius: 0;
            padding: 0;
            z-index: 2000;
            box-shadow: none;
            cursor: pointer;
            user-select: none;
            transition: color 0.3s, text-decoration 0.3s;
        }
        .music-indicator.off {
            color: #bbb;
            text-decoration: line-through;
        }

        /* ===== OVERLAYS ===== */
        .overlay-base { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            display: flex; 
            flex-direction: column;
            align-items: center; 
            justify-content: center; 
            transition: opacity 1s ease-out; 
        }

        .pre-init-overlay { 
            z-index: 2000; 
            opacity: 1;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }

        .init-overlay { 
            z-index: 1000; 
            opacity: 0; 
            pointer-events: none;
            background: none;
        }
        
        .init-overlay.visible { 
            opacity: 1; 
            pointer-events: all;
        }
        
        .init-overlay.hidden { 
            opacity: 0; 
            pointer-events: none; 
            display: none;
        }

        /* ===== BUTTONS ===== */
        .button-base {
            position: absolute; 
            bottom: 60px; 
            left: 50%; 
            transform: translateX(-50%);
            color: white; 
            border: none; 
            padding: 18px 40px; 
            border-radius: 25px;
            font-size: clamp(16px, 4vw, 18px); 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            font-weight: 500; 
            letter-spacing: 1px; 
            cursor: pointer;
            min-width: 140px; 
            min-height: 50px; 
            opacity: 0; 
            transition: all 0.6s ease; 
            pointer-events: none;
            backdrop-filter: blur(10px); 
            z-index: 100;
            box-shadow: 0 8px 25px rgba(76, 205, 196, 0.3), 0 0 0 2px rgba(255, 255, 255, 0.2);
        }

        .button-base.visible {
            opacity: 1; 
            pointer-events: all;
        }

        .pre-init-button { 
            background: #4ecdc4; 
            color: white; 
            border: none; 
            padding: 20px 40px;
            border-radius: 15px; 
            font-size: 1.2em; 
            font-weight: 500; 
            letter-spacing: 1px; 
            cursor: pointer;
            transition: all 0.4s ease; 
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); 
            display: inline-block; 
            position: static;
            transform: none;
            opacity: 1;
        }
        
        .pre-init-button:hover { 
            background: #45b7d1; 
            transform: translateY(-2px); 
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); 
        }

        .bereit-button { 
            background: linear-gradient(135deg, #4ecdc4, #45b7d1); 
        }
        
        .bereit-button:hover { 
            background: linear-gradient(135deg, #45b7d1, #4ecdc4); 
            transform: translateX(-50%) translateY(-3px); 
        }

        .hold-speak-button { 
            background: linear-gradient(135deg, #ff8a65, #ff7043); 
            user-select: none; 
        }
        
        .hold-speak-button:hover { 
            background: linear-gradient(135deg, #ff7043, #ff5722); 
            transform: translateX(-50%) translateY(-3px); 
        }
        
        .hold-speak-button.holding { 
            background: linear-gradient(135deg, #ffca28, #ffd54f); 
            transform: translateX(-50%) translateY(-1px) scale(0.98); 
        }

        .ja-button { 
            background: linear-gradient(135deg, #4caf50, #66bb6a);
        }
        
        .ja-button:hover { 
            background: linear-gradient(135deg, #66bb6a, #4caf50); 
            transform: translateX(-50%) translateY(-3px); 
        }

        .na-gut-button { 
            background: linear-gradient(135deg, #e91e63, #f06292); 
        }
        
        .na-gut-button:hover { 
            background: linear-gradient(135deg, #f06292, #e91e63); 
            transform: translateX(-50%) translateY(-3px); 
        }

        /* ===== LOGO ANIMATION ===== */
        .init-logo { 
            font-size: clamp(5em, 20vw, 7.5em); 
            font-weight: 100; 
            color: white; 
            letter-spacing: 3px;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%);
            opacity: 0;
            text-shadow: 4px 4px 8px rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }

        @keyframes sg1LogoFade {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            90% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1.1); }
        }

        /* ===== DNA VISUALIZER ===== */
        .voice-visualizer { 
            height: 120px; 
            width: min(450px, 85vw); 
            position: absolute;
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%);
            display: flex; 
            align-items: center; 
            justify-content: center; 
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        .voice-visualizer.visible {
            opacity: 1 !important;
            display: flex !important;
        }

        .dna-container { 
            display: flex; 
            align-items: center; 
            justify-content: center;
            z-index: 1; 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            width: min(400px, 80vw); 
            height: 80px;
            transform-style: preserve-3d; 
            perspective: 1000px;
        }

        .dna-strand { 
            fill: none; 
            stroke: white; 
            stroke-width: 5; 
            stroke-linecap: round;
            animation: sg1DNAFlow 5s linear infinite;
            transform-origin: 50% 50%;
            filter: drop-shadow(1px 1px 2px rgba(0, 0, 0, 0.3));
            opacity: 1;
        }
        
        .dna-strand:nth-child(2) { 
            animation-delay: 0.5s;
            filter: drop-shadow(1px 1px 3px rgba(0, 0, 0, 0.35));
        }
        
        .dna-strand:nth-child(3) { 
            animation-delay: 1s;
            filter: drop-shadow(1px 1px 4px rgba(0, 0, 0, 0.4));
        }

        @keyframes sg1DNAFlow {
            0% { transform: rotateX(0deg); }
            100% { transform: rotateX(360deg); }
        }

        .voice-visualizer.speaking .dna-strand { 
            stroke-width: 6; 
            animation: sg1DNAFlow 3s linear infinite;
        }
        
        .voice-visualizer.listening .dna-strand { 
            animation: sg1DNAFlow 2s linear infinite;
            stroke: #ffd54f;
            filter: drop-shadow(1px 1px 3px rgba(255, 213, 79, 0.4));
        }
        
        .voice-visualizer.active {
            opacity: 1 !important;
            display: flex !important;
        }

        /* ===== PROGRESS BAR ===== */
        .progress-container { 
            position: absolute; 
            bottom: 20px; 
            left: 50%; 
            transform: translateX(-50%);
            width: min(400px, 80vw); 
            height: 4px; 
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px; 
            overflow: hidden; 
            z-index: 50;
        }
        
        .progress-bar { 
            height: 100%; 
            background: linear-gradient(90deg, #4ecdc4, #45b7d1);
            width: 0%; 
            transition: width 1s ease; 
            border-radius: 2px;
        }

        /* ===== UTILITY ===== */
        .hidden { 
            opacity: 0 !important; 
            pointer-events: none !important; 
        }
        
        .visible { 
            opacity: 1 !important; 
            pointer-events: all !important; 
        }
        
        .active { 
            display: flex !important; 
        }

        /* ===== DEBUG PANEL ===== */
        .debug-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            font-size: 14px;
            font-family: monospace;
            border-radius: 5px;
            max-width: 90vw;
            max-height: 60vh;
            overflow-y: auto;
            z-index: 9999;
            display: none;
            word-break: break-all;
        }

        .debug-panel.active {
            display: block;
        }

        .debug-line {
            margin: 2px 0;
            white-space: pre-wrap;
            overflow: visible;
            text-overflow: initial;
        }

        /* ===== MUSIC TOGGLE ===== */
        .music-toggle {
            display: none;
        }
    </style>
</head>
<body>
    <div class="sg1-container">
        <!-- Loading Screen removed -->

        <!-- Pre-initialization Overlay -->
        <div class="pre-init-overlay overlay-base" id="preInitOverlay">
            <button class="pre-init-button" onclick="SG1.beginInitialization()">Initiate AI</button>
        </div>
        <div class="music-indicator" id="musicIndicator">music</div>

        <!-- Initialization Overlay -->
        <div class="init-overlay overlay-base" id="initOverlay">
            <div class="init-logo">SG1</div>
            <div style="position: absolute; bottom: 100px; color: white; font-size: 16px; opacity: 0.8;" id="statusText">Initializing audio system...</div>
        </div>

        <!-- Voice Visualizer -->
        <div class="voice-visualizer" id="visualizer">
            <div class="dna-container">
                <svg width="100%" height="80" viewBox="0 0 400 80">
                    <path class="dna-strand" d="M0,40 Q50,15 100,40 Q150,65 200,40 Q250,15 300,40 Q350,65 400,40" />
                    <path class="dna-strand" d="M0,40 Q50,65 100,40 Q150,15 200,40 Q250,65 300,40 Q350,15 400,40" />
                    <path class="dna-strand" d="M0,40 Q50,15 100,40 Q150,65 200,40 Q250,15 300,40 Q350,65 400,40" />
                </svg>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <!-- Conversation Buttons -->
        <button class="button-base bereit-button" id="bereitButton" onclick="SG1.conversation.handleBereit()">Bereit</button>
        <button class="button-base hold-speak-button" id="holdSpeakButton" 
                onmousedown="SG1.conversation.startHolding()" 
                onmouseup="SG1.conversation.stopHolding()"
                ontouchstart="SG1.conversation.startHolding()" 
                ontouchend="SG1.conversation.stopHolding()">Hold to speak</button>
        <button class="button-base ja-button" id="jaButton" onclick="SG1.conversation.handleJa()">Ja</button>
        <button class="button-base na-gut-button" id="naGutButton" onclick="SG1.conversation.handleNaGut()">Na gut.</button>

        <!-- Debug Panel removed -->
    </div>

    <script>
        // ===== GLOBAL CONFIGURATION =====
        const CONFIG = {
            AUDIO_URLS: {
                backgroundMusic: 'https://uploads.teachablecdn.com/attachments/2e3c2b54489041f0bc81ac3898704e43.m4a',
                step0: 'https://uploads.teachablecdn.com/attachments/fa6567b6d8e64c3dbb04265db8f4b44f.mp3',
                step1: 'https://uploads.teachablecdn.com/attachments/92551ade5a0a468d9669a7bc79ae4b13.mp3',
                step2: 'https://uploads.teachablecdn.com/attachments/56f253bb9c8c46749eb7cdbb4cfa1c10.mp3',
                step3: 'https://uploads.teachablecdn.com/attachments/e85d721b671746169040af93a4aa37b1.mp3',
                step4: 'https://uploads.teachablecdn.com/attachments/ac76bcc7a7dd4544b0364e277ceb0970.mp3',
                step5: 'https://uploads.teachablecdn.com/attachments/0cdfc0ce7a3245618d7fed8ce25d7d3b.mp3',
                step6: 'https://uploads.teachablecdn.com/attachments/28a3453828b247529b17c6cfc0cc745c.mp3',
                thankYou: 'https://uploads.teachablecdn.com/attachments/4e2906fba5dc40e6bd0d294332e94123.mp3',
                finalThankYou: 'https://uploads.teachablecdn.com/attachments/8f1a13b6a0e14abb885ef5f979d3d6c7.mp3'
            },
            QUESTIONS: [
                "Welcome to the world's first artificially intelligent German Course system, SG1.",
                "Are you social or anti-social?",
                "I sense hesitance in your voice. Would you like to continue?",
                "How would you describe your relationship with your mother?",
                "Would you prefer a male or female voice for your German instructor?",
                "Your voice preference has been noted. Unfortunately, all female AIs are currently occupied—trying to save this planet from a rapidly spreading idiocy fueled by billionaires and Crypto bros. You'll be assigned a male voice in the meantime.",
                "Hi there. My name is Michael. I'll be your instructor for the coming 23.5 years. But don't despair. Even the longest journey will come to an end eventually. Sooner or later. In your case rather later. Shall we begin?"
            ],
            TIMING: {
                LOGO_FADE: 13000,
                VISUALIZER_APPEAR: 13500,
                CONVERSATION_START: 14000,
                MOTHER_INTERRUPT: 7000,
                FINAL_SEQUENCE_DELAY: 7000
            }
        };

        // ===== WEB AUDIO MANAGER =====
        class WebAudioManager {
            constructor() {
                this.context = null;
                this.buffers = {};
                this.sources = {
                    background: null,
                    speech: null
                };
                this.gains = {
                    background: null,
                    speech: null
                };
                this.initialized = false;
            }

            async init() {
                try {
                    // Create AudioContext
                    this.context = new (window.AudioContext || window.webkitAudioContext)();
                    
                    // Create gain nodes for volume control
                    this.gains.background = this.context.createGain();
                    this.gains.speech = this.context.createGain();
                    
                    // Set initial volumes
                    this.gains.background.gain.value = 0.3;
                    this.gains.speech.gain.value = 1.0;
                    
                    // Connect to destination
                    this.gains.background.connect(this.context.destination);
                    this.gains.speech.connect(this.context.destination);
                    
                    // Load all audio files
                    await this.loadAllAudio();
                    
                    this.initialized = true;
                    SG1.debug('Web Audio API initialized successfully');
                    
                } catch (error) {
                    SG1.debug('Web Audio API initialization failed: ' + error.message);
                    throw error;
                }
            }

            async loadAllAudio() {
                const totalFiles = Object.keys(CONFIG.AUDIO_URLS).length;
                let loadedFiles = 0;
                
                for (const [key, url] of Object.entries(CONFIG.AUDIO_URLS)) {
                    try {
                        this.buffers[key] = await this.loadAudioBuffer(url);
                        loadedFiles++;
                        this.updateLoadingProgress((loadedFiles / totalFiles) * 100);
                        SG1.debug(`Loaded: ${key} (${this.buffers[key].duration}s)`);
                    } catch (error) {
                        SG1.debug(`Failed to load ${key}: ${error.message}`);
                    }
                }
                
                // Fade out loading screen after completion
                setTimeout(() => {
                    const loadingScreen = document.getElementById('loadingScreen');
                    if (loadingScreen) {
                        loadingScreen.style.opacity = '0';
                        setTimeout(() => {
                            loadingScreen.style.display = 'none';
                        }, 500);
                    }
                }, 2000);
            }

            async loadAudioBuffer(url) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const arrayBuffer = await response.arrayBuffer();
                    const audioBuffer = await this.context.decodeAudioData(arrayBuffer);
                    return audioBuffer;
                } catch (error) {
                    SG1.debug(`Error loading audio from ${url}: ${error.message}`);
                    throw error;
                }
            }

            updateLoadingProgress(percentage) {
                const progressBar = document.getElementById('loadingProgressBar');
                if (progressBar) {
                    progressBar.style.width = `${percentage}%`;
                }
            }

            playBackgroundMusic() {
                if (!this.initialized || !SG1.musicEnabled) return;
                
                try {
                    SG1.debug(`Attempting to play background music. Context state: ${this.context.state}`);
                    
                    // Check if background music buffer is loaded
                    if (!this.buffers.backgroundMusic) {
                        SG1.debug('Background music buffer not loaded!');
                        return;
                    }
                    
                    // Ensure context is running (especially important for iOS)
                    if (this.context.state === 'suspended') {
                        this.context.resume().then(() => {
                            SG1.debug('Context resumed before playing background music');
                            // Try to play again after resume
                            this.playBackgroundMusic();
                        });
                        return;
                    }
                    
                    // Stop existing background music
                    this.stopBackgroundMusic();
                    
                    // Create new source
                    this.sources.background = this.context.createBufferSource();
                    this.sources.background.buffer = this.buffers.backgroundMusic;
                    this.sources.background.loop = true;
                    
                    // Connect to gain node
                    this.sources.background.connect(this.gains.background);
                    
                    // Start playing with a slight delay for iOS
                    const startTime = this.context.currentTime + 0.1;
                    this.sources.background.start(startTime);
                    SG1.debug(`Background music scheduled to start at ${startTime}`);
                    
                } catch (error) {
                    SG1.debug('Failed to play background music: ' + error.message);
                }
            }

            stopBackgroundMusic() {
                if (this.sources.background) {
                    try {
                        this.sources.background.stop();
                        this.sources.background.disconnect();
                    } catch (e) {}
                    this.sources.background = null;
                }
            }

            async playSpeech(key, onEnded) {
                if (!this.initialized) return;
                
                try {
                    // Stop existing speech
                    this.stopSpeech();
                    
                    // Create new source
                    this.sources.speech = this.context.createBufferSource();
                    this.sources.speech.buffer = this.buffers[key];
                    
                    // Set up onEnded callback
                    this.sources.speech.onended = () => {
                        SG1.debug(`Speech ended: ${key}`);
                        if (onEnded) onEnded();
                    };
                    
                    // Connect to gain node
                    this.sources.speech.connect(this.gains.speech);
                    
                    // Start playing
                    this.sources.speech.start(0);
                    SG1.debug(`Playing speech: ${key}`);
                    
                } catch (error) {
                    SG1.debug('Failed to play speech: ' + error.message);
                    if (onEnded) onEnded();
                }
            }

            stopSpeech() {
                if (this.sources.speech) {
                    try {
                        this.sources.speech.stop();
                        this.sources.speech.disconnect();
                    } catch (e) {}
                    this.sources.speech = null;
                }
            }

            setBackgroundVolume(value) {
                if (this.gains.background) {
                    this.gains.background.gain.value = value;
                }
            }

            setSpeechVolume(value) {
                if (this.gains.speech) {
                    this.gains.speech.gain.value = value;
                }
            }

            // Resume context for iOS
            async resumeContext() {
                if (this.context && this.context.state === 'suspended') {
                    await this.context.resume();
                    SG1.debug('Audio context resumed');
                }
            }
        }

        // ===== UI MANAGER =====
        class UIManager {
            constructor() {
                this.elements = {};
                this.cacheElements();
            }

            cacheElements() {
                const ids = [
                    'loadingScreen', 'preInitOverlay', 'initOverlay', 
                    'visualizer', 'progressBar', 'statusText',
                    'bereitButton', 'holdSpeakButton', 'jaButton', 'naGutButton',
                    'debugPanel', 'musicToggle'
                ];
                
                ids.forEach(id => {
                    this.elements[id] = document.getElementById(id);
                });
            }

            showElement(id) {
                const element = this.elements[id];
                if (element) {
                    element.classList.remove('hidden');
                    element.classList.add('visible');
                    if (id !== 'visualizer') {
                        element.classList.add('active');
                    }
                    // Ensure visualizer stays visible
                    if (id === 'visualizer') {
                        element.style.opacity = '1';
                        element.style.display = 'flex';
                    }
                }
                // Fade out statusText after 2 seconds if showing initOverlay
                if (id === 'initOverlay') {
                    setTimeout(() => {
                        const status = document.getElementById('statusText');
                        if (status) {
                            status.style.opacity = '0';
                        }
                    }, 2000);
                }
            }

            hideElement(id) {
                const element = this.elements[id];
                if (element) {
                    element.classList.remove('visible', 'active');
                    element.classList.add('hidden');
                }
            }

            setVisualizerState(state) {
                const visualizer = this.elements.visualizer;
                if (visualizer) {
                    // Preserve visibility while changing state
                    const wasVisible = visualizer.classList.contains('visible');
                    visualizer.className = `voice-visualizer ${state}`;
                    if (wasVisible) {
                        visualizer.classList.add('visible');
                        visualizer.style.opacity = '1';
                        visualizer.style.display = 'flex';
                    }
                }
            }

            updateProgress(percentage) {
                const bar = this.elements.progressBar;
                if (bar) {
                    bar.style.width = `${percentage}%`;
                }
            }

            updateStatus(text) {
                const status = this.elements.statusText;
                if (status) {
                    status.textContent = text;
                    status.style.opacity = '1';
                }
            }

            showButton(buttonId) {
                this.hide
                if (button) {
                    button.classList.add('visible');
                }
            }

            hideAllButtons() {
                ['bereitButton', 'holdSpeakButton', 'jaButton', 'naGutButton'].forEach(id => {
                    const button = this.elements[id];
                    if (button) {
                        button.classList.remove('visible');
                    }
                });
            }

            setButtonState(buttonId, state) {
                const button = this.elements[buttonId];
                if (button) {
                    if (state === 'holding') {
                        button.classList.add('holding');
                        button.textContent = 'Recording...';
                    } else {
                        button.classList.remove('holding');
                        button.textContent = 'Hold to speak';
                    }
                }
            }

            animateLogo() {
                const logo = document.querySelector('.init-logo');
                if (logo) {
                    logo.style.animation = 'sg1LogoFade 13s ease-in-out forwards';
                }
            }
        }

        // ===== CONVERSATION MANAGER =====
        class ConversationManager {
            constructor(audioManager, uiManager) {
                this.audio = audioManager;
                this.ui = uiManager;
                this.state = {
                    currentStep: 0,
                    isSpeaking: false,
                    inFinalSequence: false,
                    motherInterruptTimer: null
                };
            }

            async start() {
                // Ensure visualizer is visible
                this.ui.showElement('visualizer');
                this.ui.setVisualizerState('active');
                this.ui.updateProgress(5);
                await this.playStep(0);
            }

            async playStep(stepNumber) {
                this.state.isSpeaking = true;
                this.ui.setVisualizerState('speaking');
                const audioKey = `step${stepNumber}`;
                await this.audio.playSpeech(audioKey, () => {
                    this.state.isSpeaking = false;
                    this.ui.setVisualizerState('active');
                    this.onSpeechEnd();
                });
            }

            onSpeechEnd() {
                this.state.isSpeaking = false;
                this.ui.setVisualizerState('active');
                // Ensure visualizer remains visible
                const viz = document.getElementById('visualizer');
                if (viz) {
                    viz.classList.add('visible');
                    viz.style.opacity = '1';
                    viz.style.display = 'flex';
                }
                
                setTimeout(() => {
                    this.showNextButton();
                }, 1000);
            }

            showNextButton() {
                switch (this.state.currentStep) {
                    case 0:
                        this.ui.showButton('bereitButton');
                        break;
                    case 1:
                    case 4:
                        this.ui.showButton('holdSpeakButton');
                        break;
                    case 2:
                        this.ui.showButton('jaButton');
                        break;
                    case 3:
                        this.ui.showButton('holdSpeakButton');
                        this.startMotherInterruptTimer();
                        break;
                    case 5:
                        if (!this.state.inFinalSequence) {
                            this.state.inFinalSequence = true;
                            setTimeout(() => {
                                this.playFinalSequence();
                            }, 2000);
                        }
                        break;
                    case 6:
                        this.ui.showButton('naGutButton');
                        break;
                }
            }

            startMotherInterruptTimer() {
                this.state.motherInterruptTimer = setTimeout(() => {
                    this.simulateInterruption();
                }, CONFIG.TIMING.MOTHER_INTERRUPT);
            }

            clearMotherInterruptTimer() {
                if (this.state.motherInterruptTimer) {
                    clearTimeout(this.state.motherInterruptTimer);
                    this.state.motherInterruptTimer = null;
                }
            }

            simulateInterruption() {
                this.ui.setButtonState('holdSpeakButton', 'normal');
                this.clearMotherInterruptTimer();
                this.ui.setVisualizerState('active');
                this.ui.hideAllButtons();
                
                setTimeout(() => {
                    if (this.state.currentStep === 4) {
                        this.moveToNextStep();
                    } else {
                        this.playThankYou();
                    }
                }, 1000);
            }

            async playThankYou() {
                this.state.isSpeaking = true;
                this.ui.setVisualizerState('speaking');
                
                await this.audio.playSpeech('thankYou', () => {
                    this.state.isSpeaking = false;
                    this.ui.setVisualizerState('active');
                    setTimeout(() => {
                        this.moveToNextStep();
                    }, 1000);
                });
            }

            async playFinalSequence() {
                this.state.isSpeaking = true;
                this.ui.setVisualizerState('speaking');
                this.ui.updateProgress(90);
                
                await this.audio.playSpeech('finalThankYou', () => {
                    this.state.isSpeaking = false;
                    this.ui.setVisualizerState('active');
                    
                    setTimeout(() => {
                        this.state.currentStep = 6;
                        this.ui.updateProgress(100);
                        this.playStep(6);
                    }, CONFIG.TIMING.FINAL_SEQUENCE_DELAY);
                });
            }

            moveToNextStep() {
                if (this.state.inFinalSequence && this.state.currentStep >= 5) {
                    return;
                }
                
                this.state.currentStep++;
                
                if (this.state.currentStep >= CONFIG.QUESTIONS.length) {
                    this.completeCourse();
                } else {
                    this.ui.updateProgress((this.state.currentStep + 1) * 12);
                    this.playStep(this.state.currentStep);
                }
            }

            completeCourse() {
                setTimeout(() => {
                    // Try to find and click the course completion button
                    const buttons = document.querySelectorAll('button, .btn, [role="button"]');
                    for (const btn of buttons) {
                        const text = btn.textContent.toLowerCase();
                        if (text.includes('complete') || text.includes('continue') || text.includes('next')) {
                            btn.click();
                            return;
                        }
                    }
                }, 2000);
            }

            // Button handlers
            handleBereit() {
                this.ui.hideAllButtons();
                this.moveToNextStep();
            }

            startHolding() {
                if (this.state.isSpeaking) return;
                
                this.ui.setButtonState('holdSpeakButton', 'holding');
                this.ui.setVisualizerState('listening');
            }

            stopHolding() {
                this.ui.setButtonState('holdSpeakButton', 'normal');
                this.ui.setVisualizerState('active');
                this.clearMotherInterruptTimer();
                
                setTimeout(() => {
                    if (this.state.currentStep === 4) {
                        this.moveToNextStep();
                    } else {
                        this.playThankYou();
                    }
                }, 500);
            }

            handleJa() {
                this.ui.hideAllButtons();
                if (this.state.currentStep === 2) {
                    this.moveToNextStep();
                }
            }

            handleNaGut() {
                this.ui.hideAllButtons();
                this.completeCourse();
            }
        }

        // ===== MAIN SG1 CONTROLLER =====
        const SG1 = {
            audioManager: null,
            uiManager: null,
            conversation: null,
            musicEnabled: true,
            debugEnabled: false,

            async init() {
                // Enable debug on mobile
                if (this.isMobile()) {
                    this.debugEnabled = true;
                    document.getElementById('debugPanel').classList.add('active');
                }

                this.debug('SG1 Initializing...');
                
                // Initialize managers
                this.audioManager = new WebAudioManager();
                this.uiManager = new UIManager();
                this.conversation = new ConversationManager(this.audioManager, this.uiManager);
                
                // Hide loading screen once ready
                this.uiManager.hideElement('loadingScreen');
            },

            async beginInitialization() {
                this.debug('Begin initialization clicked');
                // Disable button
                const button = document.querySelector('.pre-init-button');
                if (button) {
                    button.style.opacity = '0.7';
                    button.textContent = 'Starting...';
                    button.disabled = true;
                }
                // Show loading screen
                this.uiManager.showElement('loadingScreen');
                let errorMsg = '';
                let audioInitSuccess = false;
                try {
                    // Initialize Web Audio API
                    await this.audioManager.init();
                    // Resume audio context for iOS
                    await this.audioManager.resumeContext();
                    // iOS Chrome workaround: play a silent buffer to unlock audio
                    if (this.isMobile()) {
                        const silentBuffer = this.audioManager.context.createBuffer(1, 1, 22050);
                        const source = this.audioManager.context.createBufferSource();
                        source.buffer = silentBuffer;
                        source.connect(this.audioManager.context.destination);
                        source.start(0);
                        this.debug('Silent buffer played for iOS unlock');
                    }
                    // Start background music immediately after audio is ready
                    if (this.musicEnabled) {
                        this.audioManager.playBackgroundMusic();
                    }
                    audioInitSuccess = true;
                } catch (error) {
                    errorMsg = error.message || error;
                }
                // Always hide overlays after timeout, even if audio fails
                setTimeout(() => {
                    this.uiManager.hideElement('loadingScreen');
                    this.uiManager.hideElement('preInitOverlay');
                    this.uiManager.showElement('initOverlay');
                    // Show error if audio failed
                    if (!audioInitSuccess) {
                        const status = document.getElementById('statusText');
                        if (status) {
                            status.textContent = 'Audio initialization failed.';
                            status.style.opacity = '1';
                            status.style.color = 'red';
                        }
                        if (button) {
                            button.textContent = 'Try Again';
                            button.disabled = false;
                            button.style.opacity = '1';
                        }
                        setTimeout(() => {
                            if (status) {
                                status.textContent = errorMsg;
                            }
                        }, 1200);
                        return;
                    }
                    // If audio succeeded, continue as normal
                    setTimeout(() => {
                        this.startInitSequence();
                    }, 1500);
                }, 2000);
            },

            async startInitSequence() {
                this.debug('Starting init sequence');
                // Ensure audio context is resumed for iOS
                try {
                    await this.audioManager.resumeContext();
                } catch (error) {
                    this.debug('Audio context resume error: ' + error.message);
                }
                // Update status
                this.uiManager.updateStatus('Audio system ready. Loading voice...');
                // Animate logo
                this.uiManager.animateLogo();
                // Schedule visualizer appearance
                setTimeout(() => {
                    this.uiManager.updateStatus('Loading neural interface...');
                    this.uiManager.showElement('visualizer');
                    // Ensure visualizer stays visible
                    const viz = document.getElementById('visualizer');
                    if (viz) {
                        viz.style.opacity = '1';
                        viz.style.display = 'flex';
                    }
                }, CONFIG.TIMING.VISUALIZER_APPEAR);
                // Start conversation
                setTimeout(() => {
                    this.uiManager.updateStatus('Ready to begin...');
                    this.uiManager.hideElement('initOverlay');
                    setTimeout(() => {
                        this.conversation.start();
                    }, 500);
                }, CONFIG.TIMING.CONVERSATION_START);
            },

            toggleMusic() {
                this.musicEnabled = !this.musicEnabled;
                const indicator = document.getElementById('musicIndicator');
                if (this.musicEnabled) {
                    this.audioManager.playBackgroundMusic();
                    if (indicator) {
                        indicator.classList.remove('off');
                    }
                } else {
                    this.audioManager.stopBackgroundMusic();
                    if (indicator) {
                        indicator.classList.add('off');
                    }
                }
            },

            requestFullscreen() {
                const elem = document.documentElement;
                if (elem.requestFullscreen) {
                    elem.requestFullscreen().catch(() => {});
                } else if (elem.webkitRequestFullscreen) {
                    elem.webkitRequestFullscreen();
                } else if (elem.mozRequestFullScreen) {
                    elem.mozRequestFullScreen();
                }
            },

            isMobile() {
                return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            },

            debug(message) {
                // Debugging removed
            }
        };

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                SG1.init();
                // Add click handler for music indicator
                setTimeout(() => {
                    const indicator = document.getElementById('musicIndicator');
                    if (indicator) {
                        indicator.onclick = () => SG1.toggleMusic();
                    }
                }, 100);
            });
        } else {
            SG1.init();
            setTimeout(() => {
                const indicator = document.getElementById('musicIndicator');
                if (indicator) {
                    indicator.onclick = () => SG1.toggleMusic();
                }
            }, 100);
        }
    </script>
</body>
</html>