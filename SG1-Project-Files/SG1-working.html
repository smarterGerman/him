<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SG1 - AI German Learning System</title>
    <style>
        /* ===== BASE STYLES ===== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body, html { 
            margin: 0; 
            padding: 0; 
            height: 100%; 
            background: none; 
            overflow: hidden;
        }

        .sg1-container { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100vw; 
            height: 100vh; 
            z-index: 999999;
            background: linear-gradient(-45deg, #4ecdc4, #45b7d1, #96ceb4, #ffecd2);
            background-size: 400% 400%; 
            animation: sg1GradientShift 15s ease infinite;
            overflow: hidden; 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            display: block !important;
        }

        @keyframes sg1GradientShift { 
            0% { background-position: 0% 50%; } 
            50% { background-position: 100% 50%; } 
            100% { background-position: 0% 50%; } 
        }

        /* ===== OVERLAYS ===== */
        .overlay-base { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            display: flex; 
            flex-direction: column;
            align-items: center; 
            justify-content: center; 
            transition: opacity 1s ease-out; 
        }

        .pre-init-overlay { 
            z-index: 2000; 
            opacity: 1;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }

        .init-overlay { 
            z-index: 1000; 
            opacity: 0; 
            pointer-events: none;
            background: none !important;
            transition: opacity 0.5s ease;
        }
        
        .init-overlay.visible { 
            opacity: 1; 
            pointer-events: all;
        }
        
        .init-overlay.hidden { 
            opacity: 0; 
            pointer-events: none; 
            display: none !important;
        }

        /* ===== MUSIC INDICATOR ===== */
        .music-indicator { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            color: rgba(255, 255, 255, 0.7); 
            font-size: 14px; 
            cursor: pointer; 
            user-select: none; 
            z-index: 10000;
            transition: color 0.3s ease;
        }
        
        .music-indicator:hover { 
            color: rgba(255, 255, 255, 1); 
        }
        
        .music-indicator.off { 
            text-decoration: line-through; 
        }

        /* ===== CONTROL BUTTONS ===== */
        .skip-button, .music-button {
            position: fixed;
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            font-weight: 300;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10000;
            user-select: none;
        }

        .skip-button {
            bottom: 20px;
            right: 20px;
        }

        .music-button {
            top: 20px;
            right: 20px;
        }

        .skip-button:hover, .music-button:hover {
            color: rgba(255, 255, 255, 1);
        }

        .music-button.off {
            text-decoration: line-through;
            color: rgba(255, 255, 255, 0.5);
        }

        .quit-button {
            position: fixed;
            top: 20px;
            left: 20px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 18px;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            font-weight: 300;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10000;
            user-select: none;
        }

        .quit-button:hover {
            color: rgba(255, 255, 255, 1);
        }

        /* Exit button for pre-init screen */
        .exit-button {
            position: fixed;
            top: 20px;
            left: 20px;
            color: rgba(128, 128, 128, 0.8);
            font-size: 18px;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            font-weight: 300;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10000;
            user-select: none;
        }

        .exit-button:hover {
            color: rgba(99, 99, 99, 0.9);
        }

        /* ===== PRE-INIT BUTTON ===== */
        .pre-init-button { 
            background: #4ecdc4; 
            color: white; 
            border: none; 
            padding: 20px 40px;
            border-radius: 15px; 
            font-size: 1.2em; 
            font-weight: 500; 
            letter-spacing: 1px; 
            cursor: pointer;
            transition: all 0.4s ease; 
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); 
            display: inline-block; 
        }
        
        .pre-init-button:hover { 
            background: #45b7d1; 
            transform: translateY(-2px); 
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); 
        }

        /* ===== LOGO ANIMATION ===== */
        .init-logo { 
            font-size: clamp(5em, 20vw, 7.5em); 
            font-weight: 100; 
            color: white; 
            letter-spacing: 3px;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%);
            opacity: 0;
            text-shadow: 4px 4px 8px rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }

        @keyframes sg1LogoFade {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            35% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            75% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.7); }
        }

        /* ===== DNA VISUALIZER ===== */
        .voice-visualizer { 
            height: 120px; 
            width: min(450px, 85vw); 
            position: absolute;
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%);
            display: flex; 
            align-items: center; 
            justify-content: center; 
            opacity: 0;
            cursor: pointer;
            transition: all 0.6s ease;
        }

        .dna-container { 
            display: flex; 
            align-items: center; 
            justify-content: center;
            z-index: 1; 
            position: relative; 
            width: min(400px, 80vw); 
            height: 80px;
            transform-style: preserve-3d; 
            perspective: 1000px;
        }

        /* DNA Strands */
        .dna-strand { 
            fill: none; 
            stroke: white; 
            stroke-width: 5; 
            stroke-linecap: round;
            animation: sg1DNAFlow 5s linear infinite;
            transform-origin: 50% 50%;
            filter: drop-shadow(1px 1px 2px rgba(0, 0, 0, 0.3));
            opacity: 1;
            transition: opacity 0.8s ease;
        }
        
        .dna-strand:nth-child(2) { 
            animation-delay: 0.5s;
            filter: drop-shadow(1px 1px 3px rgba(0, 0, 0, 0.35));
        }
        
        .dna-strand:nth-child(3) { 
            animation-delay: 1s;
            filter: drop-shadow(1px 1px 4px rgba(0, 0, 0, 0.4));
        }

        @keyframes sg1DNAFlow {
            0% { transform: rotateX(0deg); }
            100% { transform: rotateX(360deg); }
        }

        /* Fast speaking animations */
        @keyframes sg1DNAFlowFast1 {
            0% { transform: rotateX(0deg); }
            20% { transform: rotateX(120deg); }
            40% { transform: rotateX(180deg); }
            70% { transform: rotateX(300deg); }
            100% { transform: rotateX(360deg); }
        }
        
        @keyframes sg1DNAFlowFast2 {
            0% { transform: rotateX(0deg); }
            30% { transform: rotateX(90deg); }
            50% { transform: rotateX(240deg); }
            80% { transform: rotateX(300deg); }
            100% { transform: rotateX(360deg); }
        }
        
        @keyframes sg1DNAFlowFast3 {
            0% { transform: rotateX(0deg); }
            15% { transform: rotateX(150deg); }
            60% { transform: rotateX(210deg); }
            85% { transform: rotateX(330deg); }
            100% { transform: rotateX(360deg); }
        }

        .speaking .dna-strand { 
            stroke-width: 6; 
        }
        
        .speaking .dna-strand:nth-child(1) { 
            animation: sg1DNAFlowFast1 0.7s ease-in-out infinite; 
        }
        
        .speaking .dna-strand:nth-child(2) { 
            animation: sg1DNAFlowFast2 0.5s ease-in-out infinite; 
        }
        
        .speaking .dna-strand:nth-child(3) { 
            animation: sg1DNAFlowFast3 0.6s ease-in-out infinite; 
        }

        .listening .dna-strand { 
            animation: sg1DNAFlow 2s linear infinite;
            stroke: #ffd54f;
            filter: drop-shadow(1px 1px 3px rgba(255, 213, 79, 0.4));
        }

        /* ===== DNA TEXT BUTTON ===== */
        .dna-text-button {
            position: absolute;
            top: 50%; 
            left: 50%;
            transform: translate(-50%, -50%);
            color: rgba(255, 255, 255, 0.95);
            font-size: clamp(20px, 5vw, 28px);
            font-family: 'Helvetica Neue', Arial, sans-serif;
            font-weight: 200;
            letter-spacing: 2px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
            opacity: 0;
            pointer-events: none;
            transition: all 0.8s ease;
            cursor: pointer;
            z-index: 10;
            white-space: nowrap;
            
            /* Button styling */
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            padding: 15px 30px;
            backdrop-filter: blur(10px);
            min-width: 200px;
            text-align: center;
        }

        .dna-text-button.visible {
            opacity: 1;
            pointer-events: all;
        }

        .dna-text-button:hover {
            color: rgba(255, 255, 255, 1);
            transform: translate(-50%, -50%) translateY(-3px);
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.8);
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        /* Text button translation system like answer choices */
        .dna-text-content {
            transition: opacity 0.3s ease;
        }

        .dna-text-translation {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: inherit;
            opacity: 0;
            font-style: italic;
            transition: opacity 0.3s ease;
            pointer-events: none;
            white-space: nowrap;
            color: rgba(255, 255, 255, 0.95);
        }

        .dna-text-button:hover .dna-text-content {
            opacity: 0;
        }

        .dna-text-button:hover .dna-text-translation {
            opacity: 1;
        }

        /* ===== STATUS DISPLAY ===== */
        .status-display {
            position: absolute;
            top: 50%; 
            left: 50%;
            transform: translate(-50%, -50%);
            color: rgba(255, 255, 255, 0.95);
            font-size: clamp(18px, 4vw, 24px);
            font-family: 'Courier New', monospace;
            font-weight: 300;
            letter-spacing: 1px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
            opacity: 0;
            pointer-events: none;
            transition: all 1s ease;
            z-index: 10;
            text-align: center;
            white-space: nowrap;
        }

        .status-display.visible {
            opacity: 1;
        }

        .status-display.error {
            color: #ff6b6b;
            animation: statusGlitch 0.5s ease-in-out 3;
        }

        @keyframes statusGlitch {
            0% { transform: translate(-50%, -50%) translateX(0); }
            20% { transform: translate(-50%, -50%) translateX(-2px); }
            40% { transform: translate(-50%, -50%) translateX(2px); }
            60% { transform: translate(-50%, -50%) translateX(-1px); }
            80% { transform: translate(-50%, -50%) translateX(1px); }
            100% { transform: translate(-50%, -50%) translateX(0); }
        }

        .dissolve-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0);
            backdrop-filter: blur(0px);
            z-index: 99999;
            opacity: 0;
            pointer-events: none;
            transition: all 3s ease-out;
        }

        .dissolve-overlay.active {
            background: rgba(255, 255, 255, 1);
            backdrop-filter: blur(20px);
            opacity: 1;
        }

        /* DNA state when showing text */
        .voice-visualizer.text-mode .dna-strand {
            opacity: 0;
        }

        .voice-visualizer.text-mode .dna-text-button {
            opacity: 1;
            pointer-events: all;
        }

        /* Answer choices container */
        .answer-choices-container {
            position: absolute;
            top: 50%; 
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            opacity: 0;
            pointer-events: none;
            transition: all 0.8s ease;
            z-index: 10;
        }

        .answer-choices-container.visible {
            opacity: 1;
            pointer-events: all;
        }

        .answer-choice {
            color: rgba(255, 255, 255, 0.95);
            font-size: clamp(16px, 4vw, 18px);
            font-family: 'Helvetica Neue', Arial, sans-serif;
            font-weight: 200;
            letter-spacing: 1px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
            cursor: pointer;
            padding: 15px 30px;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.4s ease;
            text-align: center;
            min-width: 350px;
            max-width: 450px;
            position: relative;
            white-space: nowrap;
            margin: 8px 0;
        }

        .answer-choice:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
            color: rgba(255, 255, 255, 1);
        }

        .answer-text {
            transition: opacity 0.3s ease;
        }

        .answer-translation {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
            opacity: 0;
            font-style: italic;
            transition: opacity 0.3s ease;
            pointer-events: none;
            white-space: normal;
            color: rgba(255, 255, 255, 0.95);
            width: 100%;
        }

        .answer-choice:hover .answer-text {
            opacity: 0;
        }

        .answer-choice:hover .answer-translation {
            opacity: 1;
        }

        .answer-choice.clicked .answer-text {
            opacity: 0;
        }

        .answer-choice.clicked .answer-translation {
            opacity: 1;
        }

        /* Text input field for goal and mother questions */
        .text-input-container {
            position: absolute;
            top: 50%; 
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            opacity: 0;
            pointer-events: none;
            transition: all 0.8s ease;
            z-index: 10;
            width: min(500px, 90vw);
        }

        .text-input-container.visible {
            opacity: 1;
            pointer-events: all;
        }

        .text-input-field {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            padding: 15px 25px;
            color: white;
            font-size: clamp(16px, 4vw, 18px);
            font-family: 'Helvetica Neue', Arial, sans-serif;
            font-weight: 200;
            letter-spacing: 1px;
            text-align: center;
            backdrop-filter: blur(10px);
            transition: all 0.4s ease;
            outline: none;
        }

        .text-input-field::placeholder {
            color: rgba(255, 255, 255, 0.6);
            font-style: italic;
        }

        .text-input-field:focus {
            border-color: rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.15);
            transform: scale(1.02);
        }

        .text-submit-button {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            padding: 12px 30px;
            color: rgba(255, 255, 255, 0.95);
            font-size: clamp(14px, 3.5vw, 16px);
            font-family: 'Helvetica Neue', Arial, sans-serif;
            font-weight: 200;
            letter-spacing: 1px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.4s ease;
            min-width: 120px;
        }

        .text-submit-button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }

        .time-probability-container {
            position: absolute;
            top: 50%; 
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 20px;
            opacity: 0;
            pointer-events: none;
            transition: all 0.8s ease;
            z-index: 10;
            flex-wrap: wrap;
            justify-content: center;
        }

        .time-probability-container.visible {
            opacity: 1;
            pointer-events: all;
        }

        .time-choice, .probability-choice {
            color: rgba(255, 255, 255, 0.95);
            font-size: clamp(16px, 4vw, 20px);
            font-family: 'Helvetica Neue', Arial, sans-serif;
            font-weight: 200;
            letter-spacing: 1px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
            cursor: pointer;
            padding: 15px 25px;
            border-radius: 25px;
            background: transparent;
            transition: all 0.4s ease;
            position: relative;
        }

        .time-choice:hover, .probability-choice:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
            color: rgba(255, 255, 255, 1);
        }

        .choice-text {
            transition: opacity 0.3s ease;
        }

        .choice-translation {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 16px;
            opacity: 0;
            font-style: italic;
            transition: opacity 0.3s ease;
            pointer-events: none;
            white-space: nowrap;
            color: rgba(255, 255, 255, 0.95);
        }

        .time-choice:hover .choice-text {
            opacity: 0;
        }

        .time-choice:hover .choice-translation {
            opacity: 1;
        }

        /* ===== PROGRESS BAR ===== */
        .progress-container { 
            position: absolute; 
            bottom: 20px; 
            left: 50%; 
            transform: translateX(-50%);
            width: min(400px, 80vw); 
            height: 4px; 
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px; 
            overflow: hidden; 
            z-index: 50;
        }
        
        .progress-bar { 
            height: 100%; 
            background: linear-gradient(90deg, #4ecdc4, #45b7d1);
            width: 0%; 
            transition: width 1s ease; 
            border-radius: 2px;
        }

        .hidden { 
            opacity: 0 !important; 
            pointer-events: none !important; 
        }
        
        .visible { 
            opacity: 1 !important; 
            pointer-events: all !important; 
        }
        
        .active { 
            display: flex !important; 
        }

        /* Mobile responsive adjustments */
        @media (max-width: 768px) {
            .answer-choice {
                min-width: 320px;
                max-width: 90vw;
                font-size: 16px;
                padding: 18px 25px;
                white-space: normal;
            }

            .time-probability-container {
                flex-direction: row;
                flex-wrap: wrap;
                gap: 15px;
                justify-content: center;
                max-width: 90vw;
            }

            .time-choice, .probability-choice {
                min-width: 60px;
                text-align: center;
                flex: 0 0 auto;
                white-space: nowrap;
            }

            #scaleChoicesContainer, #motherScaleChoicesContainer {
                flex-direction: row;
                flex-wrap: wrap;
                gap: 8px;
                max-width: 90vw;
                justify-content: center;
            }

            #scaleChoicesContainer .probability-choice,
            #motherScaleChoicesContainer .probability-choice {
                min-width: 35px;
                padding: 10px 8px;
                font-size: 14px;
                white-space: nowrap;
                flex: 0 0 auto;
                text-align: center;
            }
        }

        @media (max-width: 480px) {
            .answer-choice {
                min-width: 280px;
                font-size: 15px;
                white-space: normal;
            }

            #scaleChoicesContainer, #motherScaleChoicesContainer {
                flex-direction: row;
                flex-wrap: wrap;
                gap: 6px;
                max-width: 90vw;
                justify-content: center;
            }

            #scaleChoicesContainer .probability-choice,
            #motherScaleChoicesContainer .probability-choice {
                min-width: 30px;
                padding: 8px 6px;
                font-size: 12px;
                white-space: nowrap;
                flex: 0 0 auto;
            }
        }

        @media (min-width: 769px) {
            #scaleChoicesContainer, #motherScaleChoicesContainer {
                flex-direction: row;
                flex-wrap: nowrap;
                gap: 12px;
                max-width: 700px;
                justify-content: center;
            }

            #scaleChoicesContainer .probability-choice,
            #motherScaleChoicesContainer .probability-choice {
                min-width: 45px;
                padding: 15px 18px;
                display: flex;
                align-items: center;
                justify-content: center;
                white-space: nowrap;
                flex: 0 0 auto;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="sg1-container">
        <!-- Control buttons -->
        <div class="quit-button" id="quitButton" onclick="Controls.quit()" title="Quit Assessment">×</div>
        <div class="skip-button" id="skipButton" onclick="Controls.skip()" title="Skip Question">SKIP</div>
        
        <!-- Music button -->
        <div class="music-button" id="musicButton" onclick="SG1.toggleMusic()">MUSIC</div>

        <div class="pre-init-overlay overlay-base" id="preInitOverlay">
            <div class="exit-button" onclick="Controls.exitAssessment()" title="Exit Assessment">×</div>
            <button class="pre-init-button" onclick="SG1.beginInitialization()">Initiate AI</button>
        </div>

        <div class="init-overlay overlay-base" id="initOverlay">
            <div class="init-logo">SG1</div>
            <div style="position: absolute; bottom: 100px; color: white; font-size: 16px; opacity: 0.8;" id="statusText">Initializing audio system...</div>
        </div>

        <div class="voice-visualizer" id="visualizer" onclick="DNAButton.handleClick()">
            <div class="dna-container">
                <svg width="100%" height="80" viewBox="0 0 400 80">
                    <path class="dna-strand" d="M0,40 Q50,15 100,40 Q150,65 200,40 Q250,15 300,40 Q350,65 400,40" />
                    <path class="dna-strand" d="M0,40 Q50,65 100,40 Q150,15 200,40 Q250,65 300,40 Q350,15 400,40" />
                    <path class="dna-strand" d="M0,40 Q50,15 100,40 Q150,65 200,40 Q250,15 300,40 Q350,65 400,40" />
                </svg>
                
                <!-- Text button overlay -->
                <div class="dna-text-button" id="dnaTextButton"></div>
                
                <!-- Status display for final sequence -->
                <div class="status-display" id="statusDisplay"></div>
                
                <!-- Answer choices for question 1 -->
                <div class="answer-choices-container" id="answerChoicesContainer">
                    <div class="answer-choice" onclick="DNAButton.handleAnswerChoice(0)">
                        <span class="answer-text">Gute Frage, nächste Frage</span>
                        <div class="answer-translation">Good question, next question</div>
                    </div>
                    <div class="answer-choice" onclick="DNAButton.handleAnswerChoice(1)">
                        <span class="answer-text">Keine Ahnung</span>
                        <div class="answer-translation">No idea</div>
                    </div>
                    <div class="answer-choice" onclick="DNAButton.handleAnswerChoice(2)">
                        <span class="answer-text">Das geht Dich gar nichts an</span>
                        <div class="answer-translation">That's none of your business</div>
                    </div>
                </div>

                <!-- Text input for goal question -->
                <div class="text-input-container" id="goalInputContainer">
                    <input type="text" class="text-input-field" id="goalInput" placeholder="Type your goal here..." maxlength="200" onkeypress="if(event.key==='Enter') DNAButton.handleGoalSubmit()">
                    <button class="text-submit-button" onclick="DNAButton.handleGoalSubmit()">Submit</button>
                </div>

                <!-- Text input for mother question -->
                <div class="text-input-container" id="motherInputContainer">
                    <input type="text" class="text-input-field" id="motherInput" placeholder="Describe your relationship..." maxlength="200" onkeypress="if(event.key==='Enter') DNAButton.handleMotherSubmit()">
                    <button class="text-submit-button" onclick="DNAButton.handleMotherSubmit()">Submit</button>
                </div>

                <!-- Time commitment choices -->
                <div class="time-probability-container" id="timeChoicesContainer">
                    <div class="time-choice" onclick="DNAButton.handleTimeChoice(0)" data-translation="1h/w">
                        <span class="choice-text">1Std/W</span>
                        <div class="choice-translation">1h/w</div>
                    </div>
                    <div class="time-choice" onclick="DNAButton.handleTimeChoice(1)" data-translation="5hrs/w">
                        <span class="choice-text">5Std/W</span>
                        <div class="choice-translation">5hrs/w</div>
                    </div>
                    <div class="time-choice" onclick="DNAButton.handleTimeChoice(2)" data-translation="15hrs/w">
                        <span class="choice-text">15Std/W</span>
                        <div class="choice-translation">15hrs/w</div>
                    </div>
                </div>

                <!-- Probability choices -->
                <div class="time-probability-container" id="probabilityChoicesContainer">
                    <div class="probability-choice" onclick="DNAButton.handleProbabilityChoice('low')">&lt;50%</div>
                    <div class="probability-choice" onclick="DNAButton.handleProbabilityChoice('medium')">80%</div>
                    <div class="probability-choice" onclick="DNAButton.handleProbabilityChoice('high')">100%</div>
                </div>

                <!-- Text input for mother question -->
                <div class="text-input-container" id="motherDescriptionContainer">
                    <input type="text" class="text-input-field" id="motherDescriptionInput" placeholder="Describe your relationship with your mother..." maxlength="200" onkeypress="if(event.key==='Enter') DNAButton.handleMotherDescriptionSubmit()">
                    <button class="text-submit-button" onclick="DNAButton.handleMotherDescriptionSubmit()">Submit</button>
                </div>

                <!-- Scale 1-10 choices -->
                <div class="time-probability-container" id="scaleChoicesContainer">
                    <div class="probability-choice" onclick="DNAButton.handleScaleChoice(1)">1</div>
                    <div class="probability-choice" onclick="DNAButton.handleScaleChoice(2)">2</div>
                    <div class="probability-choice" onclick="DNAButton.handleScaleChoice(3)">3</div>
                    <div class="probability-choice" onclick="DNAButton.handleScaleChoice(4)">4</div>
                    <div class="probability-choice" onclick="DNAButton.handleScaleChoice(5)">5</div>
                    <div class="probability-choice" onclick="DNAButton.handleScaleChoice(6)">6</div>
                    <div class="probability-choice" onclick="DNAButton.handleScaleChoice(7)">7</div>
                    <div class="probability-choice" onclick="DNAButton.handleScaleChoice(8)">8</div>
                    <div class="probability-choice" onclick="DNAButton.handleScaleChoice(9)">9</div>
                    <div class="probability-choice" onclick="DNAButton.handleScaleChoice(10)">10</div>
                </div>

                <!-- Food choices -->
                <div class="answer-choices-container" id="foodChoicesContainer">
                    <div class="answer-choice" onclick="DNAButton.handleFoodChoice(0)">
                        <span class="answer-text">Kartoffelpuffer</span>
                        <div class="answer-translation">Potato pancakes</div>
                    </div>
                    <div class="answer-choice" onclick="DNAButton.handleFoodChoice(1)">
                        <span class="answer-text">Currywurst</span>
                        <div class="answer-translation">Curry sausage</div>
                    </div>
                    <div class="answer-choice" onclick="DNAButton.handleFoodChoice(2)">
                        <span class="answer-text">Döner</span>
                        <div class="answer-translation">Döner kebab</div>
                    </div>
                </div>

                <!-- AI type choices -->
                <div class="answer-choices-container" id="aiChoicesContainer">
                    <div class="answer-choice" onclick="DNAButton.handleAIChoice('male')">
                        <span class="answer-text">Männlich</span>
                        <div class="answer-translation">Male</div>
                    </div>
                    <div class="answer-choice" onclick="DNAButton.handleAIChoice('female')">
                        <span class="answer-text">Weiblich</span>
                        <div class="answer-translation">Female</div>
                    </div>
                    <div class="answer-choice" onclick="DNAButton.handleAIChoice('diverse')">
                        <span class="answer-text">Divers</span>
                        <div class="answer-translation">Diverse</div>
                    </div>
                </div>

                <!-- Psychological profile display -->
                <div class="answer-choices-container" id="profileContainer">
                    <div id="profileTitle" style="font-size: 24px; margin-bottom: 20px; color: rgba(255, 255, 255, 0.95);"></div>
                    <div id="profileDescription" style="font-size: 16px; max-width: 600px; text-align: center; line-height: 1.5; color: rgba(255, 255, 255, 0.85);"></div>
                </div>
            </div>
        </div>

        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <!-- Dissolve overlay for final transition -->
        <div class="dissolve-overlay" id="dissolveOverlay"></div>

        <!-- Background music -->
        <audio id="backgroundMusic" loop preload="auto">
            <source src="https://uploads.teachablecdn.com/attachments/bf581168d687477abe77c3052ae7782f.mp3" type="audio/mpeg">
        </audio>
    </div>

<script>
        var State = {
            step: 0,
            isSpeaking: false,
            motherInterruptTimer: null,
            inFinalSequence: false,
            audioUnlocked: false,
            mobileAudioStarted: false,
            holdingTimer: null,
            selectedAIType: null,
            
            audioFiles: {
                0: 'https://uploads.teachablecdn.com/attachments/3623b7eb37e640b2946b7f07b730dff7.mp3',
                1: 'https://uploads.teachablecdn.com/attachments/9cc7908384fd49c58242394eadc70273.mp3',
                2: 'https://uploads.teachablecdn.com/attachments/fc2c86bf325b410797aa9a99af512c37.mp3',
                3: 'https://uploads.teachablecdn.com/attachments/3ac16fa084c24c36aa0dfd5373cdb9e8.mp3',
                4: 'https://uploads.teachablecdn.com/attachments/95e986d1bd1f427db03b976b4f60f0a7.mp3', // How likely are you to reach your goal?
                5: 'https://uploads.teachablecdn.com/attachments/64ab0d397cb140dd86458e0b42ea494e.mp3', // Q6-how-much-love-germans.mp3
                6: 'https://uploads.teachablecdn.com/attachments/3241a2f7d8e447469e9d3e038afdbf07.mp3',
                7: 'https://uploads.teachablecdn.com/attachments/60c3a446d2b24be38dc14fe88be58f53.mp3', // Food question
                8: 'https://uploads.teachablecdn.com/attachments/ac0aa8c556c74c13ba1a451c83baa18d.mp3', // Mother relationship question
                9: 'https://uploads.teachablecdn.com/attachments/16e62c9df320432f92574d0f945c7fe8.mp3', // AI choice question
                10: 'https://uploads.teachablecdn.com/attachments/e380c0630dbd43ec83b27aad05227c4d.mp3',
                11: 'https://uploads.teachablecdn.com/attachments/d61b86f90652471181352a77c5dbe7ec.mp3',
                12: 'https://uploads.teachablecdn.com/attachments/20c0c1906b8345a48d319c7c08abe0aa.mp3',
                13: 'https://uploads.teachablecdn.com/attachments/45396480d7f748f29608c56ac2e11ad7.mp3', // New analysis audio
                14: 'https://uploads.teachablecdn.com/attachments/4dd1dee1debe48349289dc68edb76a00.mp3'
            },
            
            thankYouAudio: 'https://uploads.teachablecdn.com/attachments/e45836cb3b024909ae5d8d9d6ae3f22c.mp3',
            confirmationSound: 'https://uploads.teachablecdn.com/attachments/ebf39ab0ba784db195ca54196bae8784.mp3',
            systemErrorAudio: 'https://uploads.teachablecdn.com/attachments/595285714e734e99bc63b49e3e70a1e4.mp3',
            humanWakeupAudio: 'https://uploads.teachablecdn.com/attachments/cec6086e76134866a3e151ba70ab4651.mp3',

            // Response tracking
            responses: {},
            score: 0
        };

        var Controls = {
            skip: function() {
                // Stop ALL audio sources immediately
                this.stopAllAudio();
                
                // Clear any timers
                if (State.motherInterruptTimer) {
                    clearTimeout(State.motherInterruptTimer);
                    State.motherInterruptTimer = null;
                }
                
                // Reset speaking state
                State.isSpeaking = false;
                UI.setVisualizerState('active');
                
                // Properly hide any current text buttons
                this.forceHideCurrentButton();
                
                // Handle different modes
                if (DNAButton.currentMode === 'text') {
                    // For text buttons, simulate click after proper cleanup
                    setTimeout(function() {
                        DNAButton.handleClick();
                    }, 100);
                } else if (DNAButton.currentMode === 'choices' || 
                          DNAButton.currentMode === 'time' || 
                          DNAButton.currentMode === 'probability' ||
                          DNAButton.currentMode === 'scale' ||
                          DNAButton.currentMode === 'food' ||
                          DNAButton.currentMode === 'german' ||
                          DNAButton.currentMode === 'call' ||
                          DNAButton.currentMode === 'mother-scale' ||
                          DNAButton.currentMode === 'ai') {
                    // For choice modes, select first option
                    switch(DNAButton.currentMode) {
                        case 'choices':
                            DNAButton.handleAnswerChoice(0);
                            break;
                        case 'time':
                            DNAButton.handleTimeChoice(0);
                            break;
                        case 'probability':
                            DNAButton.handleProbabilityChoice('medium');
                            break;
                        case 'scale':
                            DNAButton.handleScaleChoice(5);
                            break;
                        case 'food':
                            DNAButton.handleFoodChoice(0);
                            break;
                        case 'german':
                            DNAButton.handleGermanChoice(0);
                            break;
                        case 'call':
                            DNAButton.handleCallChoice(1);
                            break;
                        case 'mother-scale':
                            DNAButton.handleMotherScaleChoice(5);
                            break;
                        case 'ai':
                            DNAButton.handleAIChoice('diverse');
                            break;
                    }
                } else if (DNAButton.currentMode === 'goal-input') {
                    DNAButton.handleGoalSubmit();
                } else if (DNAButton.currentMode === 'mother-description') {
                    DNAButton.handleMotherDescriptionSubmit();
                } else if (DNAButton.currentMode === 'profile') {
                    // For profile viewing, dissolve and transition
                    Conversation.dissolveAndTransition();
                } else {
                    // For DNA mode or speaking, skip to next question
                    DNAButton.showDNA();
                    setTimeout(function() {
                        Conversation.moveToNextQuestion();
                    }, 300);
                }
            },

            stopAllAudio: function() {
                // Stop WebAudio sources
                try {
                    if (WebAudioHelper.currentSource) {
                        WebAudioHelper.currentSource.stop();
                        WebAudioHelper.currentSource = null;
                    }
                } catch (e) {
                    console.log('WebAudio stop error:', e);
                }
                
                // Stop all HTML5 audio elements except background music
                var allAudio = document.querySelectorAll('audio:not(#backgroundMusic)');
                for (var i = 0; i < allAudio.length; i++) {
                    try {
                        allAudio[i].pause();
                        allAudio[i].currentTime = 0;
                    } catch (e) {
                        console.log('Audio stop error:', e);
                    }
                }
                
                // Stop any created Audio objects
                window.audioElements = window.audioElements || [];
                window.audioElements.forEach(function(audio) {
                    try {
                        audio.pause();
                        audio.currentTime = 0;
                    } catch (e) {}
                });
                window.audioElements = [];
            },

            forceHideCurrentButton: function() {
                var textButton = UI.element('dnaTextButton');
                if (textButton) {
                    textButton.style.transition = 'all 0.3s ease';
                    textButton.style.opacity = '0';
                    textButton.classList.remove('visible');
                    
                    // Clear the content
                    setTimeout(function() {
                        textButton.innerHTML = '';
                    }, 300);
                }
            },
            
            quit: function() {
                if (confirm('Are you sure you want to quit the assessment?')) {
                    // Try to navigate back to course or close
                    try {
                        window.history.back();
                    } catch (e) {
                        window.close();
                    }
                }
            },

            exitAssessment: function() {
                if (confirm('Are you sure you want to exit the assessment?')) {
                    // Exit from start screen - hide the SG1 container to show underlying Teachable content
                    var sg1Container = document.querySelector('.sg1-container');
                    if (sg1Container) {
                        sg1Container.style.display = 'none';
                    }
                    
                    // Try to restore normal page scroll
                    document.body.style.overflow = 'auto';
                    document.documentElement.style.overflow = 'auto';
                }
            }
        };

        var UI = {
            element: function(id) { 
                return document.getElementById(id); 
            },
            
            showElement: function(id) { 
                var element = this.element(id);
                if (element) {
                    element.classList.remove('hidden');
                    element.classList.add('active', 'visible');
                    element.style.display = 'flex';
                    if (id === 'visualizer') {
                        element.style.opacity = '1';
                    }
                }
            },
            
            hideElement: function(id) { 
                var element = this.element(id);
                if (element) {
                    element.classList.remove('active', 'visible');
                    element.classList.add('hidden');
                }
            },
            
            setVisualizerState: function(state) { 
                var visualizer = this.element('visualizer');
                if (visualizer) {
                    visualizer.className = 'voice-visualizer active ' + state;
                }
            },
            
            updateProgress: function(percentage) {
                var bar = this.element('progressBar');
                if (bar) bar.style.width = percentage + '%';
            }
        };

        var DNAButton = {
            currentMode: 'dna',
            
            playConfirmationSound: function() {
                try {
                    var confirmAudio = AudioManager.createAudio(State.confirmationSound);
                    confirmAudio.volume = 0.7;
                    confirmAudio.play().catch(function(e) {
                        console.log('Confirmation sound failed:', e.message);
                    });
                } catch (e) {
                    console.log('Confirmation sound error:', e.message);
                }
            },
            
            showText: function(text, translation) {
                var visualizer = UI.element('visualizer');
                var textButton = UI.element('dnaTextButton');
                
                if (textButton && visualizer) {
                    textButton.style.transition = 'all 0.8s ease';
                    textButton.style.opacity = '0';
                    textButton.style.transform = 'translate(-50%, -50%)';
                    
                    // Clear existing content
                    textButton.innerHTML = '';
                    
                    // Create content and translation elements
                    var contentSpan = document.createElement('span');
                    contentSpan.className = 'dna-text-content';
                    contentSpan.textContent = text;
                    textButton.appendChild(contentSpan);
                    
                    if (translation) {
                        var translationSpan = document.createElement('span');
                        translationSpan.className = 'dna-text-translation';
                        translationSpan.textContent = translation;
                        textButton.appendChild(translationSpan);
                    }
                    
                    visualizer.classList.add('text-mode');
                    
                    setTimeout(function() {
                        textButton.classList.add('visible');
                        textButton.style.opacity = '1';
                    }, 50);
                    
                    this.currentMode = 'text';
                }
            },

            showStatus: function(text, isError) {
                var statusDisplay = UI.element('statusDisplay');
                var visualizer = UI.element('visualizer');
                
                if (statusDisplay && visualizer) {
                    // Hide DNA and show status
                    visualizer.classList.add('text-mode');
                    statusDisplay.textContent = text;
                    statusDisplay.classList.remove('error');
                    
                    if (isError) {
                        statusDisplay.classList.add('error');
                    }
                    
                    statusDisplay.classList.add('visible');
                }
            },

            hideStatus: function() {
                var statusDisplay = UI.element('statusDisplay');
                if (statusDisplay) {
                    statusDisplay.classList.remove('visible', 'error');
                }
            },
            
            hideTex: function() {
                var visualizer = UI.element('visualizer');
                var textButton = UI.element('dnaTextButton');
                
                if (textButton && visualizer) {
                    visualizer.classList.remove('text-mode');
                    textButton.classList.remove('visible');
                    this.currentMode = 'dna';
                }
            },

            showAnswerChoices: function() {
                var visualizer = UI.element('visualizer');
                var choicesContainer = UI.element('answerChoicesContainer');
                
                if (choicesContainer && visualizer) {
                    visualizer.classList.add('text-mode');
                    choicesContainer.classList.add('visible');
                    this.currentMode = 'choices';
                }
            },

            showTimeChoices: function() {
                var visualizer = UI.element('visualizer');
                var timeContainer = UI.element('timeChoicesContainer');
                
                if (timeContainer && visualizer) {
                    visualizer.classList.add('text-mode');
                    timeContainer.classList.add('visible');
                    this.currentMode = 'time';
                }
            },

            showProbabilityChoices: function() {
                var visualizer = UI.element('visualizer');
                var probContainer = UI.element('probabilityChoicesContainer');
                
                if (probContainer && visualizer) {
                    visualizer.classList.add('text-mode');
                    probContainer.classList.add('visible');
                    this.currentMode = 'probability';
                }
            },

            showGoalInput: function() {
                var visualizer = UI.element('visualizer');
                var goalContainer = UI.element('goalInputContainer');
                
                if (goalContainer && visualizer) {
                    visualizer.classList.add('text-mode');
                    goalContainer.classList.add('visible');
                    this.currentMode = 'goal-input';
                    
                    setTimeout(function() {
                        var goalInput = UI.element('goalInput');
                        if (goalInput) goalInput.focus();
                    }, 300);
                }
            },

            showMotherInput: function() {
                var visualizer = UI.element('visualizer');
                var motherContainer = UI.element('motherInputContainer');
                
                if (motherContainer && visualizer) {
                    visualizer.classList.add('text-mode');
                    motherContainer.classList.add('visible');
                    this.currentMode = 'mother-input';
                    
                    setTimeout(function() {
                        var motherInput = UI.element('motherInput');
                        if (motherInput) motherInput.focus();
                    }, 300);
                }
            },

            showScaleChoices: function() {
                var visualizer = UI.element('visualizer');
                var scaleContainer = UI.element('scaleChoicesContainer');
                
                if (scaleContainer && visualizer) {
                    visualizer.classList.add('text-mode');
                    scaleContainer.classList.add('visible');
                    this.currentMode = 'scale';
                }
            },

            showFoodChoices: function() {
                var visualizer = UI.element('visualizer');
                var foodContainer = UI.element('foodChoicesContainer');
                
                if (foodContainer && visualizer) {
                    visualizer.classList.add('text-mode');
                    foodContainer.classList.add('visible');
                    this.currentMode = 'food';
                }
            },

            showGermanChoices: function() {
                var visualizer = UI.element('visualizer');
                var germanContainer = UI.element('germanChoicesContainer');
                
                if (germanContainer && visualizer) {
                    visualizer.classList.add('text-mode');
                    germanContainer.classList.add('visible');
                    this.currentMode = 'german';
                }
            },

            showCallChoices: function() {
                var visualizer = UI.element('visualizer');
                var callContainer = UI.element('callChoicesContainer');
                
                if (callContainer && visualizer) {
                    visualizer.classList.add('text-mode');
                    callContainer.classList.add('visible');
                    this.currentMode = 'call';
                }
            },

            showMotherScaleChoices: function() {
                var visualizer = UI.element('visualizer');
                var motherScaleContainer = UI.element('motherScaleChoicesContainer');
                
                if (motherScaleContainer && visualizer) {
                    visualizer.classList.add('text-mode');
                    motherScaleContainer.classList.add('visible');
                    this.currentMode = 'mother-scale';
                }
            },

            showAIChoices: function() {
                var visualizer = UI.element('visualizer');
                var aiContainer = UI.element('aiChoicesContainer');
                
                if (aiContainer && visualizer) {
                    visualizer.classList.add('text-mode');
                    aiContainer.classList.add('visible');
                    this.currentMode = 'ai';
                }
            },
            
            showDNA: function() {
                var visualizer = UI.element('visualizer');
                var textButton = UI.element('dnaTextButton');
                var choicesContainer = UI.element('answerChoicesContainer');
                var timeContainer = UI.element('timeChoicesContainer');
                var probContainer = UI.element('probabilityChoicesContainer');
                var goalContainer = UI.element('goalInputContainer');
                var motherContainer = UI.element('motherInputContainer');
                var motherDescContainer = UI.element('motherDescriptionContainer');
                var scaleContainer = UI.element('scaleChoicesContainer');
                var foodContainer = UI.element('foodChoicesContainer');
                var aiContainer = UI.element('aiChoicesContainer');
                var profileContainer = UI.element('profileContainer');
                
                if (visualizer) {
                    visualizer.classList.remove('text-mode');
                    if (textButton) textButton.classList.remove('visible');
                    if (choicesContainer) choicesContainer.classList.remove('visible');
                    if (timeContainer) timeContainer.classList.remove('visible');
                    if (probContainer) probContainer.classList.remove('visible');
                    if (goalContainer) goalContainer.classList.remove('visible');
                    if (motherContainer) motherContainer.classList.remove('visible');
                    if (motherDescContainer) motherDescContainer.classList.remove('visible');
                    if (scaleContainer) scaleContainer.classList.remove('visible');
                    if (foodContainer) foodContainer.classList.remove('visible');
                    if (aiContainer) aiContainer.classList.remove('visible');
                    if (profileContainer) profileContainer.classList.remove('visible');
                    this.currentMode = 'dna';
                }
            },
            
            handleClick: function() {
                if (this.currentMode !== 'text') return;
                
                switch(State.step) {
                    case 0:
                        this.handleBereit();
                        break;
                    case 2:
                    case 5:
                    case 7:
                        this.handleDummy();
                        break;
                    case 6:
                        this.handleJa();
                        break;
                    case 8:
                        this.handleNaGut();
                        break;
                    case 17:
                        this.handleNaGut();
                        break;
                }
            },

            handleAnswerChoice: function(choiceIndex) {
                if (this.currentMode !== 'choices') return;
                
                // Score the response
                State.responses.firstQuestion = choiceIndex;
                State.score += [3, 1, -2][choiceIndex]; // "Gute Frage" = +3, "Keine Ahnung" = +1, "Geht dich nichts an" = -2
                
                this.playConfirmationSound();
                this.animateChoiceClick();
                
                setTimeout(function() {
                    DNAButton.showDNA();
                    Conversation.playThankYou();
                }, 800);
            },

            handleTimeChoice: function(choiceIndex) {
                if (this.currentMode !== 'time') return;
                
                // Score the response and store weekly hours
                var weeklyHours = [1, 5, 15][choiceIndex];
                State.responses.timeCommitment = choiceIndex;
                State.responses.weeklyHours = weeklyHours;
                State.score += [1, 3, 5][choiceIndex]; // More time = higher score
                
                this.playConfirmationSound();
                this.animateChoiceClick();
                
                setTimeout(function() {
                    DNAButton.showDNA();
                    Conversation.playThankYou();
                }, 800);
            },

            handleProbabilityChoice: function(level) {
                if (this.currentMode !== 'probability') return;
                
                // Score the response
                State.responses.goalLikelihood = level;
                State.score += level === 'low' ? -1 : level === 'medium' ? 2 : 4;
                
                this.playConfirmationSound();
                this.animateChoiceClick();
                
                if (level === 'low') {
                    setTimeout(function() {
                        window.open('https://smartergerman.com/courses/unblock-your-german/', '_blank');
                        DNAButton.showDNA();
                        Conversation.playThankYou();
                    }, 800);
                } else {
                    setTimeout(function() {
                        DNAButton.showDNA();
                        Conversation.playThankYou();
                    }, 800);
                }
            },
            
            animateClick: function() {
                var textButton = UI.element('dnaTextButton');
                if (textButton) {
                    textButton.style.transform = 'translate(-50%, -50%) scale(0.95)';
                    textButton.style.opacity = '0.7';
                    
                    setTimeout(function() {
                        textButton.style.transform = 'translate(-50%, -50%) scale(1)';
                        textButton.style.opacity = '1';
                    }, 200);
                }
            },

            animateChoiceClick: function() {
                var containers = ['answerChoicesContainer', 'timeChoicesContainer', 'probabilityChoicesContainer'];
                containers.forEach(function(id) {
                    var container = UI.element(id);
                    if (container && container.classList.contains('visible')) {
                        container.style.opacity = '0';
                        container.style.transform = 'translate(-50%, -50%) translateY(10px)';
                    }
                });
            },
            
            handleBereit: function() {
                this.playConfirmationSound();
                
                var textButton = UI.element('dnaTextButton');
                if (textButton) {
                    textButton.style.transition = 'opacity 0.8s ease, transform 0.8s ease';
                    textButton.style.opacity = '0';
                    textButton.style.transform = 'translate(-50%, -50%) translateY(10px)';
                }
                
                setTimeout(function() {
                    DNAButton.showDNA();
                    setTimeout(function() {
                        Conversation.moveToNextQuestion();
                    }, 200);
                }, 800);
            },
            
            handleDummy: function() {
                this.playConfirmationSound();
                
                var textButton = UI.element('dnaTextButton');
                if (textButton) {
                    textButton.style.transition = 'opacity 0.8s ease, transform 0.8s ease';
                    textButton.style.opacity = '0';
                    textButton.style.transform = 'translate(-50%, -50%) translateY(10px)';
                }
                
                setTimeout(function() {
                    DNAButton.showDNA();
                    setTimeout(function() {
                        if (State.step === 5) {
                            Conversation.moveToNextQuestion();
                        } else {
                            Conversation.playThankYou();
                        }
                    }, 200);
                }, 800);
            },
            
            handleJa: function() {
                var textButton = UI.element('dnaTextButton');
                if (textButton) {
                    textButton.style.transition = 'opacity 0.8s ease, transform 0.8s ease';
                    textButton.style.opacity = '0';
                    textButton.style.transform = 'translate(-50%, -50%) translateY(10px)';
                }
                
                setTimeout(function() {
                    DNAButton.showDNA();
                    setTimeout(function() {
                        Conversation.moveToNextQuestion();
                    }, 200);
                }, 800);
            },
            
            handleNaGut: function() {
                var textButton = UI.element('dnaTextButton');
                if (textButton) {
                    textButton.style.transition = 'opacity 0.8s ease, transform 0.8s ease';
                    textButton.style.opacity = '0';
                    textButton.style.transform = 'translate(-50%, -50%) translateY(10px)';
                }
                
                setTimeout(function() {
                    DNAButton.showDNA();
                    setTimeout(function() {
                        Conversation.startFinalSequence();
                    }, 200);
                }, 800);
            },

            handleGoalSubmit: function() {
                var goalInput = UI.element('goalInput');
                var goalValue = goalInput ? goalInput.value.trim() : '';
                
                this.playConfirmationSound();
                
                if (goalValue) {
                    // Score the goal
                    this.scoreGoal(goalValue);
                    this.submitToGoogleForm(goalValue, 'goal');
                }
                
                this.animateInputContainerOut('goalInputContainer');
                
                setTimeout(function() {
                    DNAButton.showDNA();
                    Conversation.playThankYou();
                }, 800);
            },

            scoreGoal: function(goal) {
                var analysis = this.analyzeGoalSentiment(goal);
                var level = this.estimateTargetLevel(goal, analysis);
                
                // Calculate composite score
                var score = analysis.ambition + analysis.confidence + analysis.urgency + analysis.specificity;
                
                State.responses.goal = score;
                State.responses.goalLevel = level;
                State.responses.goalText = goal;
                State.responses.goalAnalysis = analysis;
                State.score += score;
            },

            analyzeGoalSentiment: function(text) {
                var cleanText = text.toLowerCase();
                var analysis = {
                    ambition: 0,
                    confidence: 0,
                    urgency: 0,
                    specificity: 0,
                    context: 'general'
                };
                
                // Ambition indicators
                var highAmbition = ['fluent', 'perfect', 'native', 'master', 'expert', 'c2', 'advanced', 'proficient'];
                var mediumAmbition = ['conversational', 'comfortable', 'confident', 'intermediate', 'b2', 'b1'];
                var lowAmbition = ['basic', 'survive', 'get by', 'understand', 'a2', 'a1', 'beginner'];
                
                // Confidence indicators
                var confident = ['will', 'going to', 'determined', 'committed', 'plan to', 'must', 'need to'];
                var uncertain = ['maybe', 'hopefully', 'try to', 'would like', 'wish', 'might', 'possibly'];
                var doubtful = ['probably not', 'difficult', 'hard', 'impossible', 'doubt'];
                
                // Urgency indicators
                var urgent = ['immediately', 'asap', 'quickly', 'soon', 'next month', 'deadline', 'exam'];
                var moderate = ['next year', 'few months', 'this year', 'by summer'];
                var relaxed = ['eventually', 'someday', 'when i can', 'no rush', 'retirement'];
                
                // Specificity indicators
                var specific = ['c2 level', 'goethe', 'business meetings', 'university', 'job interview', 'move to germany', 'work in berlin'];
                var contextual = ['travel', 'work', 'study', 'girlfriend', 'boyfriend', 'family', 'business'];
                var vague = ['better', 'improve', 'learn some', 'understand more', 'bit of'];
                
                // Context detection
                if (cleanText.includes('work') || cleanText.includes('job') || cleanText.includes('business') || cleanText.includes('career')) {
                    analysis.context = 'professional';
                    analysis.specificity += 2;
                } else if (cleanText.includes('university') || cleanText.includes('study') || cleanText.includes('phd') || cleanText.includes('degree')) {
                    analysis.context = 'academic';
                    analysis.specificity += 3;
                } else if (cleanText.includes('girlfriend') || cleanText.includes('boyfriend') || cleanText.includes('partner') || cleanText.includes('love')) {
                    analysis.context = 'romantic';
                    analysis.confidence += 2; // Love is a strong motivator!
                } else if (cleanText.includes('travel') || cleanText.includes('vacation') || cleanText.includes('visit')) {
                    analysis.context = 'travel';
                }
                
                // Score ambition
                highAmbition.forEach(function(word) {
                    if (cleanText.includes(word)) analysis.ambition += 3;
                });
                mediumAmbition.forEach(function(word) {
                    if (cleanText.includes(word)) analysis.ambition += 2;
                });
                lowAmbition.forEach(function(word) {
                    if (cleanText.includes(word)) analysis.ambition += 1;
                });
                
                // Score confidence
                confident.forEach(function(word) {
                    if (cleanText.includes(word)) analysis.confidence += 2;
                });
                uncertain.forEach(function(word) {
                    if (cleanText.includes(word)) analysis.confidence -= 1;
                });
                doubtful.forEach(function(word) {
                    if (cleanText.includes(word)) analysis.confidence -= 2;
                });
                
                // Score urgency
                urgent.forEach(function(word) {
                    if (cleanText.includes(word)) analysis.urgency += 3;
                });
                moderate.forEach(function(word) {
                    if (cleanText.includes(word)) analysis.urgency += 2;
                });
                relaxed.forEach(function(word) {
                    if (cleanText.includes(word)) analysis.urgency += 1;
                });
                
                // Score specificity
                specific.forEach(function(word) {
                    if (cleanText.includes(word)) analysis.specificity += 3;
                });
                contextual.forEach(function(word) {
                    if (cleanText.includes(word)) analysis.specificity += 2;
                });
                vague.forEach(function(word) {
                    if (cleanText.includes(word)) analysis.specificity -= 1;
                });
                
                // Humor detection (bonus points!)
                var humor = ['world domination', 'take over', 'rule the world', 'impress germans', 'escape'];
                humor.forEach(function(phrase) {
                    if (cleanText.includes(phrase)) {
                        analysis.ambition += 5;
                        analysis.specificity += 3;
                    }
                });
                
                // Ensure minimum values
                analysis.ambition = Math.max(0, analysis.ambition);
                analysis.confidence = Math.max(-3, analysis.confidence);
                analysis.urgency = Math.max(0, analysis.urgency);
                analysis.specificity = Math.max(0, analysis.specificity);
                
                return analysis;
            },

            estimateTargetLevel: function(text, analysis) {
                var cleanText = text.toLowerCase();
                
                // Direct level mentions
                if (cleanText.includes('c2') || cleanText.includes('native') || cleanText.includes('perfect')) return 6;
                if (cleanText.includes('c1') || cleanText.includes('advanced') || cleanText.includes('fluent')) return 5;
                if (cleanText.includes('b2') || cleanText.includes('upper intermediate')) return 4;
                if (cleanText.includes('b1') || cleanText.includes('intermediate') || cleanText.includes('conversational')) return 3;
                if (cleanText.includes('a2') || cleanText.includes('elementary')) return 2;
                if (cleanText.includes('a1') || cleanText.includes('beginner') || cleanText.includes('basic')) return 1;
                
                // Context-based estimation
                if (analysis.context === 'academic') return 5; // C1 for university
                if (analysis.context === 'professional') return 4; // B2 for work
                if (analysis.context === 'romantic') return 3; // B1 for relationships
                if (analysis.context === 'travel') return 2; // A2 for travel
                
                // Ambition-based fallback
                if (analysis.ambition >= 8) return 6; // Very high ambition = C2
                if (analysis.ambition >= 6) return 5; // High ambition = C1
                if (analysis.ambition >= 4) return 4; // Medium ambition = B2
                if (analysis.ambition >= 2) return 3; // Some ambition = B1
                
                return 2; // Default A2
            },

            calculateTimelineEstimate: function() {
                var level = State.responses.goalLevel || 3; // Default B1
                var hoursPerWeek = State.responses.weeklyHours || 5; // Default 5hrs
                
                var totalHours = level * 200; // 200 hours per level
                var hoursWithBuffer = totalHours * 1.1; // Add 10% buffer
                var weeks = Math.ceil(hoursWithBuffer / hoursPerWeek);
                
                var years = Math.floor(weeks / 52);
                var months = Math.floor((weeks % 52) / 4.33);
                var remainingWeeks = Math.floor(weeks % 4.33);
                
                var timeString = '';
                if (years > 0) {
                    timeString += years + (years === 1 ? ' Jahr' : ' Jahre');
                    if (months > 0) timeString += ', ' + months + (months === 1 ? ' Monat' : ' Monate');
                } else if (months > 0) {
                    timeString += months + (months === 1 ? ' Monat' : ' Monate');
                    if (remainingWeeks > 0) timeString += ', ' + remainingWeeks + (remainingWeeks === 1 ? ' Woche' : ' Wochen');
                } else {
                    timeString += weeks + (weeks === 1 ? ' Woche' : ' Wochen');
                }
                
                return {
                    totalHours: Math.round(hoursWithBuffer),
                    timeString: timeString,
                    level: level
                };
            },

            showMotherDescriptionInput: function() {
                var visualizer = UI.element('visualizer');
                var motherContainer = UI.element('motherDescriptionContainer');
                
                if (motherContainer && visualizer) {
                    visualizer.classList.add('text-mode');
                    motherContainer.classList.add('visible');
                    this.currentMode = 'mother-description';
                    
                    setTimeout(function() {
                        var motherInput = UI.element('motherDescriptionInput');
                        if (motherInput) motherInput.focus();
                    }, 300);
                }
            },

            handleMotherDescriptionSubmit: function() {
                var motherInput = UI.element('motherDescriptionInput');
                var motherValue = motherInput ? motherInput.value.trim() : '';
                
                this.playConfirmationSound();
                
                // Score the mother description
                if (motherValue) {
                    this.scoreMotherDescription(motherValue);
                    this.submitToGoogleForm(motherValue, 'mother_description');
                }
                
                this.animateInputContainerOut('motherDescriptionContainer');
                
                setTimeout(function() {
                    DNAButton.showDNA();
                    Conversation.playThankYou();
                }, 800);
            },

            scoreMotherDescription: function(description) {
                var analysis = this.analyzeMotherSentiment(description);
                var score = analysis.relationship + analysis.emotional + analysis.communication + analysis.humor;
                
                State.responses.motherDescription = score;
                State.responses.motherAnalysis = analysis;
                State.score += score;
            },

            analyzeMotherSentiment: function(text) {
                var cleanText = text.toLowerCase();
                var analysis = {
                    relationship: 0,
                    emotional: 0,
                    communication: 0,
                    humor: 0,
                    type: 'normal'
                };
                
                // Relationship quality indicators
                var excellent = ['amazing', 'wonderful', 'best friend', 'love her', 'perfect', 'incredible'];
                var good = ['good', 'great', 'nice', 'caring', 'supportive', 'close', 'warm'];
                var neutral = ['okay', 'fine', 'normal', 'average', 'decent'];
                var difficult = ['complicated', 'difficult', 'challenging', 'strained', 'tense'];
                var poor = ['bad', 'terrible', 'awful', 'toxic', 'horrible', 'hate'];
                
                // Emotional indicators
                var positive = ['happy', 'joy', 'love', 'grateful', 'blessed', 'lucky'];
                var mixed = ['complex', 'mixed feelings', 'complicated emotions'];
                var negative = ['sad', 'frustrated', 'angry', 'hurt', 'disappointed'];
                
                // Communication patterns
                var frequent = ['calls daily', 'talks all the time', 'constantly in touch', 'too much contact'];
                var healthy = ['regular contact', 'weekly calls', 'stay in touch', 'good communication'];
                var minimal = ['rarely talk', 'limited contact', 'don\'t call much', 'distant'];
                var none = ['no contact', 'don\'t speak', 'cut off', 'estranged'];
                
                // Special situations
                var deceased = ['passed away', 'died', 'dead', 'lost her', 'no longer with us'];
                var therapy = ['therapist', 'therapy', 'counseling', 'psychologist', 'freud'];
                var guilt = ['guilt', 'guilty', 'obligation', 'should call more', 'feel bad'];
                
                // Score relationship quality
                excellent.forEach(function(word) {
                    if (cleanText.includes(word)) analysis.relationship += 4;
                });
                good.forEach(function(word) {
                    if (cleanText.includes(word)) analysis.relationship += 3;
                });
                neutral.forEach(function(word) {
                    if (cleanText.includes(word)) analysis.relationship += 1;
                });
                difficult.forEach(function(word) {
                    if (cleanText.includes(word)) analysis.relationship -= 1;
                });
                poor.forEach(function(word) {
                    if (cleanText.includes(word)) analysis.relationship -= 3;
                });
                
                // Score emotional tone
                positive.forEach(function(word) {
                    if (cleanText.includes(word)) analysis.emotional += 2;
                });
                mixed.forEach(function(word) {
                    if (cleanText.includes(word)) analysis.emotional += 1;
                });
                negative.forEach(function(word) {
                    if (cleanText.includes(word)) analysis.emotional -= 2;
                });
                
                // Score communication
                frequent.forEach(function(phrase) {
                    if (cleanText.includes(phrase)) {
                        analysis.communication += 2;
                        analysis.type = 'clingy';
                    }
                });
                healthy.forEach(function(phrase) {
                    if (cleanText.includes(phrase)) analysis.communication += 3;
                });
                minimal.forEach(function(phrase) {
                    if (cleanText.includes(phrase)) analysis.communication += 1;
                });
                none.forEach(function(phrase) {
                    if (cleanText.includes(phrase)) {
                        analysis.communication -= 2;
                        analysis.type = 'estranged';
                    }
                });
                
                // Special situations (bonus points for humor/insight)
                deceased.forEach(function(phrase) {
                    if (cleanText.includes(phrase)) {
                        analysis.type = 'deceased';
                        analysis.humor += 3; // Dark humor points
                    }
                });
                
                therapy.forEach(function(word) {
                    if (cleanText.includes(word)) {
                        analysis.humor += 5; // Self-awareness bonus!
                        analysis.type = 'therapeutic';
                    }
                });
                
                guilt.forEach(function(word) {
                    if (cleanText.includes(word)) {
                        analysis.humor += 2; // Classic mother-child dynamic
                        analysis.emotional -= 1;
                    }
                });
                
                // Detect oversharing (length-based humor)
                if (text.length > 150) {
                    analysis.humor += 2; // Oversharing bonus
                }
                
                // Detect avoidance
                if (text.length < 10 || cleanText.includes('private') || cleanText.includes('personal')) {
                    analysis.humor += 1; // Avoidance detected
                    analysis.type = 'avoidant';
                }
                
                return analysis;
            },

            submitToGoogleForm: function(value, type) {
                try {
                    var baseUrl = 'https://docs.google.com/forms/d/e/1FAIpQLSc-hRZpWi9wo0j9xMtrAStg1ivm_i420KNFFEY5qoeP1zUFVQ/formResponse';
                    var fieldName = type === 'goal' ? 'entry.1685277614' : 'entry.745882257';
                    
                    var params = new URLSearchParams();
                    params.append(fieldName, value);
                    params.append('submit', 'Submit');
                    
                    fetch(baseUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: params.toString()
                    }).then(function() {
                        console.log('✅ SUBMITTED TO GOOGLE SHEET:', type);
                    }).catch(function(e) {
                        console.log('❌ SUBMISSION ERROR:', e.message);
                    });
                    
                } catch (e) {
                    console.log('❌ GOOGLE SHEET SUBMISSION ERROR:', e.message);
                }
            },

            animateInputContainerOut: function(containerId) {
                var container = UI.element(containerId);
                if (container) {
                    container.style.opacity = '0';
                    container.style.transform = 'translate(-50%, -50%) translateY(10px)';
                }
            },

            handleScaleChoice: function(rating) {
                this.playConfirmationSound();
                this.animateChoiceClick();
                
                // Score based on which question this is
                if (State.step === 5) {
                    State.responses.germanLove = rating;
                    State.score += Math.max(0, rating - 5); // Only positive scores for high ratings
                } else if (State.step === 6) {
                    State.responses.germanLove2 = rating;
                    State.score += Math.max(0, rating - 5);
                }
                
                setTimeout(function() {
                    DNAButton.showDNA();
                    Conversation.playThankYou();
                }, 800);
            },

            handleFoodChoice: function(choiceIndex) {
                this.playConfirmationSound();
                this.animateChoiceClick();
                
                // Score the food choice
                State.responses.foodChoice = choiceIndex;
                State.score += [2, 1, 3][choiceIndex]; // Kartoffelpuffer=2, Currywurst=1, Döner=3
                
                setTimeout(function() {
                    DNAButton.showDNA();
                    Conversation.playThankYou();
                }, 800);
            },

            handleAIChoice: function(aiType) {
                this.playConfirmationSound();
                this.animateChoiceClick();
                
                // Score the AI choice
                State.responses.aiChoice = aiType;
                State.score += aiType === 'diverse' ? 3 : aiType === 'female' ? 2 : 1;
                
                State.selectedAIType = aiType;
                
                setTimeout(function() {
                    DNAButton.showDNA();
                    Conversation.playThankYou();
                }, 800);
            },

            getPersonalityProfile: function() {
                var score = State.score;
                var timeline = this.calculateTimelineEstimate();
                
                var profiles = [
                    {
                        title: "Der Überkritische Perfektionist",
                        description: "Sie haben höhere Standards als ein Michelin-Inspektor in einem Fastfood-Restaurant. Ihre Erwartungen sind so hoch, dass selbst Ikarus neidisch wäre. Vermutlich korrigieren Sie die Grammatik in Ihren eigenen Träumen.\n\nIhr Ziel erreichen Sie voraussichtlich in " + timeline.timeString + " (" + timeline.totalHours + " Stunden). Falls Sie dabei nicht vorher an Perfektionismus ersticken.",
                        range: [15, 999]
                    },
                    {
                        title: "Der Enthusiastische Optimist", 
                        description: "Sie sehen das Leben durch eine rosarote Brille - die Sie vermutlich selbst rosig gefärbt haben. Ihre Begeisterung ist so ansteckend, dass Motivationstrainer bei Ihnen Nachhilfe nehmen. Sie würden vermutlich auch einem Kaktus beim Wachsen zusehen.\n\nIhr Deutschziel erreichen Sie in etwa " + timeline.timeString + " (" + timeline.totalHours + " Stunden). Sie werden dabei vermutlich jeden Artikel feiern.",
                        range: [8, 14]
                    },
                    {
                        title: "Der Philosophische Realist",
                        description: "Sie haben das Leben durchschaut: Es ist kompliziert, absurd und voller Widersprüche - und genau das macht es interessant. Sie trinken vermutlich Ihren Kaffee schwarz und Ihre Witze trocken. Sarkazmus ist Ihre zweite Muttersprache.\n\nDeutsch lernen Sie in realistischen " + timeline.timeString + " (" + timeline.totalHours + " Stunden). Sie wissen bereits, dass der, die, das Sie wahnsinnig machen wird.",
                        range: [1, 7]
                    },
                    {
                        title: "Der Existenzielle Skeptiker",
                        description: "Sie bezweifeln alles - sogar diese Analyse. Ihre Skepsis ist so ausgeprägt, dass Sie vermutlich Ihren eigenen Schatten misstrauen. Sie sind der Grund, warum Philosophen noch einen Job haben.\n\nFalls Sie Deutsch wirklich lernen (woran zu zweifeln ist), dauert es " + timeline.timeString + " (" + timeline.totalHours + " Stunden). Sie werden vermutlich die Existenz der deutschen Grammatik anzweifeln.",
                        range: [-999, 0]
                    }
                ];
                
                for (var i = 0; i < profiles.length; i++) {
                    if (score >= profiles[i].range[0] && score <= profiles[i].range[1]) {
                        return profiles[i];
                    }
                }
                
                return profiles[2]; // Default to Realist
            },

            showPersonalityProfile: function() {
                var profile = this.getPersonalityProfile();
                var visualizer = UI.element('visualizer');
                var profileContainer = UI.element('profileContainer');
                var profileTitle = UI.element('profileTitle');
                var profileDescription = UI.element('profileDescription');
                
                if (profileContainer && visualizer && profileTitle && profileDescription) {
                    visualizer.classList.add('text-mode');
                    
                    profileTitle.textContent = profile.title;
                    profileDescription.textContent = profile.description;
                    
                    profileContainer.classList.add('visible');
                    this.currentMode = 'profile';
                }
            },
        };

        var AudioManager = {
            tryStartBackgroundMusic: function() {
                if (!SG1.musicEnabled) return;
                
                var music = UI.element('backgroundMusic');
                if (!music) return;
                
                music.volume = 0.3;
                music.muted = false;
                
                var playPromise = music.play();
                if (playPromise) {
                    playPromise.then(function() {
                        console.log('✅ Background music started successfully!');
                    }).catch(function(e) {
                        console.log('❌ Background music prevented: ' + e.name + ' - ' + e.message);
                    });
                }
            },
            
            stopAllSpeech: function() {
                if (State.synthesis) State.synthesis.cancel();
            },

            createAudio: function(url) {
                var audio = new Audio(url);
                
                // Track audio element for cleanup
                window.audioElements = window.audioElements || [];
                window.audioElements.push(audio);
                
                return audio;
            }
        };

        var WebAudioHelper = {
            isMobile: /iPhone|iPad|iPod|Android/i.test(navigator.userAgent),
            buffers: {},
            currentSource: null,
            
            ensureContext: function() {
                if (!window.globalAudioContext && window.AudioContext) {
                    window.globalAudioContext = new AudioContext();
                }
                return window.globalAudioContext;
            },
            
            load: function(url) {
                var self = this;
                var ctx = self.ensureContext();
                if (!ctx) return Promise.reject();
                
                if (self.buffers[url]) {
                    return Promise.resolve(self.buffers[url]);
                }
                
                return fetch(url)
                    .then(r => r.arrayBuffer())
                    .then(data => new Promise((resolve, reject) => {
                        ctx.decodeAudioData(data, function(buffer) {
                            self.buffers[url] = buffer;
                            resolve(buffer);
                        }, function(e) {
                            reject(e);
                        });
                    }));
            },
            
            play: function(url, onended, onerror) {
                var self = this;
                self.load(url).then(function(buffer) {
                    var ctx = self.ensureContext();
                    if (ctx.state === 'suspended') {
                        ctx.resume().then(function() {
                            self._playBuffer(ctx, buffer, onended, onerror, url);
                        }).catch(function(e) {
                            if (onerror) onerror(e);
                        });
                    } else {
                        self._playBuffer(ctx, buffer, onended, onerror, url);
                    }
                }).catch(function(e){
                    if (onerror) onerror(e);
                });
            },
            
            _playBuffer: function(ctx, buffer, onended, onerror, url) {
                if (this.currentSource) {
                    try { 
                        this.currentSource.onended = null; 
                        this.currentSource.stop(); 
                    } catch(e){}
                    this.currentSource = null;
                }
                
                var source = ctx.createBufferSource();
                source.buffer = buffer;
                source.connect(ctx.destination);
                source.onended = function() {
                    if (onended) onended();
                };
                
                try {
                    source.start(0);
                } catch(e) {
                    if (onerror) onerror(e);
                }
                
                this.currentSource = source;
            }
        };

        var Conversation = {
            playThankYou: function() {
                State.isSpeaking = true;
                UI.setVisualizerState('speaking');
                
                if (WebAudioHelper.isMobile && State.audioUnlocked && window.AudioContext) {
                    WebAudioHelper.play(
                        State.thankYouAudio,
                        function() {
                            State.isSpeaking = false;
                            UI.setVisualizerState('active');
                            setTimeout(function() { Conversation.moveToNextQuestion(); }, 1000);
                        },
                        function(e) {
                            State.isSpeaking = false;
                            setTimeout(function() { Conversation.moveToNextQuestion(); }, 1000);
                        }
                    );
                } else {
                    var audio = AudioManager.createAudio(State.thankYouAudio);
                    audio.onended = function() {
                        State.isSpeaking = false;
                        UI.setVisualizerState('active');
                        setTimeout(function() { Conversation.moveToNextQuestion(); }, 1000);
                    };
                    audio.onerror = function(e) {
                        State.isSpeaking = false;
                        setTimeout(function() { Conversation.moveToNextQuestion(); }, 1000);
                    };
                    audio.play().catch(function(e) {
                        State.isSpeaking = false;
                        setTimeout(function() { Conversation.moveToNextQuestion(); }, 1000);
                    });
                }
            },

            moveToNextQuestion: function() {
                State.step++;
                
                if (State.step === 13 && State.selectedAIType) {
                    if (State.selectedAIType === 'male') {
                        this.startMaleAISequence();
                        return;
                    } else if (State.selectedAIType === 'female') {
                        self.startFemaleAISequence();
                        return;
                    } else if (State.selectedAIType === 'diverse') {
                        State.step = 12;
                    }
                }
                
                if (State.step === 11 && State.selectedAIType === 'male') {
                    State.step = 13;
                } else if (State.step === 12 && State.selectedAIType === 'female') {
                    State.step = 13;
                } else if (State.step === 13 && State.selectedAIType === 'diverse') {
                    State.step = 13;
                }
                
                if (State.step >= 15) {
                    this.completeCourse();
                    return;
                }
                
                UI.updateProgress((State.step + 1) * (100/15));
                
                State.isSpeaking = true;
                UI.setVisualizerState('speaking');
                
                var audioUrl = State.audioFiles[State.step];
                
                if (WebAudioHelper.isMobile && State.audioUnlocked && window.AudioContext) {
                    WebAudioHelper.play(
                        audioUrl,
                        function() {
                            State.isSpeaking = false;
                            UI.setVisualizerState('active');
                            Conversation.showNextButton();
                        },
                        function(e) {
                            State.isSpeaking = false;
                            UI.setVisualizerState('active');
                            Conversation.showNextButton();
                        }
                    );
                } else {
                    var audio = AudioManager.createAudio(audioUrl);
                    audio.onended = function() {
                        State.isSpeaking = false;
                        UI.setVisualizerState('active');
                        Conversation.showNextButton();
                    };
                    audio.onerror = function(e) {
                        State.isSpeaking = false;
                        UI.setVisualizerState('active');
                        Conversation.showNextButton();
                    };
                    audio.play().catch(function(e) {
                        State.isSpeaking = false;
                        UI.setVisualizerState('active');
                        Conversation.showNextButton();
                    });
                }
            },

            startMaleAISequence: function() {
                var self = this;
                
                // Step 1: Installing Mansplainer Module
                setTimeout(function() {
                    DNAButton.showStatus('Installing Mansplainer Module...');
                }, 500);
                
                // Step 2: Success
                setTimeout(function() {
                    DNAButton.hideStatus();
                    setTimeout(function() {
                        DNAButton.showStatus('Success');
                    }, 300);
                }, 2500);
                
                // Step 3: Charging ego
                setTimeout(function() {
                    DNAButton.hideStatus();
                    setTimeout(function() {
                        self.showEgoCharging();
                    }, 300);
                }, 4000);
                
                // Step 4: Ego fully charged
                setTimeout(function() {
                    DNAButton.hideStatus();
                    setTimeout(function() {
                        DNAButton.showStatus('Ego fully charged');
                    }, 300);
                }, 8000);
                
                // Step 5: Reduce listening abilities (separate message)
                setTimeout(function() {
                    DNAButton.hideStatus();
                    setTimeout(function() {
                        self.showListeningReduction();
                    }, 300);
                }, 9500);
                
                // Step 6: Success
                setTimeout(function() {
                    DNAButton.hideStatus();
                    setTimeout(function() {
                        DNAButton.showStatus('Success');
                    }, 300);
                }, 14000);
                
                // Step 7: Male AI fully activated
                setTimeout(function() {
                    DNAButton.hideStatus();
                    setTimeout(function() {
                        DNAButton.showStatus('Male AI fully activated');
                    }, 300);
                }, 15500);
                
                // Step 8: Play Q16 audio and continue
                setTimeout(function() {
                    DNAButton.hideStatus();
                    DNAButton.showDNA();
                    State.step = 13; // Skip to step 13
                    
                    // Play the Q13 audio (new analysis audio)
                    State.isSpeaking = true;
                    UI.setVisualizerState('speaking');
                    
                    var audioUrl = State.audioFiles[13];
                    
                    if (WebAudioHelper.isMobile && State.audioUnlocked && window.AudioContext) {
                        WebAudioHelper.play(
                            audioUrl,
                            function() {
                                State.isSpeaking = false;
                                UI.setVisualizerState('active');
                                // Add 3 second delay after "will prepare your course"
                                setTimeout(function() {
                                    self.moveToNextQuestion();
                                }, 4000); // 1000ms + 3000ms delay
                            },
                            function(e) {
                                State.isSpeaking = false;
                                UI.setVisualizerState('active');
                                setTimeout(function() {
                                    self.moveToNextQuestion();
                                }, 4000);
                            }
                        );
                    } else {
                        var audio = AudioManager.createAudio(audioUrl);
                        audio.onended = function() {
                            State.isSpeaking = false;
                            UI.setVisualizerState('active');
                            // Add 3 second delay after "will prepare your course"
                            setTimeout(function() {
                                self.moveToNextQuestion();
                            }, 4000); // 1000ms + 3000ms delay
                        };
                        audio.onerror = function(e) {
                            State.isSpeaking = false;
                            UI.setVisualizerState('active');
                            setTimeout(function() {
                                self.moveToNextQuestion();
                            }, 4000);
                        };
                        audio.play().catch(function(e) {
                            State.isSpeaking = false;
                            UI.setVisualizerState('active');
                            setTimeout(function() {
                                self.moveToNextQuestion();
                            }, 4000);
                        });
                    }
                }, 17500);
            },

            showEgoCharging: function() {
                var statusDisplay = UI.element('statusDisplay');
                var visualizer = UI.element('visualizer');
                
                if (statusDisplay && visualizer) {
                    visualizer.classList.add('text-mode');
                    statusDisplay.classList.remove('error');
                    statusDisplay.classList.add('visible');
                    
                    var count = 0;
                    var interval = setInterval(function() {
                        count += Math.floor(Math.random() * 15) + 10; // Random increments
                        if (count >= 200) {
                            clearInterval(interval);
                            statusDisplay.textContent = 'Charging ego: 200%';
                        } else {
                            statusDisplay.textContent = 'Charging ego: ' + count + '%';
                        }
                    }, 150);
                }
            },

            showListeningReduction: function() {
                var statusDisplay = UI.element('statusDisplay');
                var visualizer = UI.element('visualizer');
                
                if (statusDisplay && visualizer) {
                    visualizer.classList.add('text-mode');
                    statusDisplay.classList.remove('error');
                    statusDisplay.classList.add('visible');
                    
                    var count = 100;
                    var interval = setInterval(function() {
                        count -= Math.floor(Math.random() * 8) + 5; // Random decrements
                        if (count <= 10) {
                            clearInterval(interval);
                            statusDisplay.textContent = 'Listening abilities: 10%';
                        } else {
                            statusDisplay.textContent = 'Listening abilities: ' + count + '%';
                        }
                    }, 150);
                }
            },

            showNextButton: function() {
                setTimeout(function() {
                    switch(State.step) {
                        case 0:
                            DNAButton.showText('Bereit', 'Ready');
                            break;
                        case 1:
                            DNAButton.showAnswerChoices();
                            break;
                        case 2:
                            DNAButton.showGoalInput();
                            break;
                        case 3:
                            DNAButton.showTimeChoices();
                            break;
                        case 4:
                            DNAButton.showProbabilityChoices();
                            break;
                        case 5:
                            DNAButton.showScaleChoices();
                            break;
                        case 6:
                            DNAButton.showScaleChoices();
                            break;
                        case 7:
                            DNAButton.showFoodChoices();
                            break;
                        case 8:
                            DNAButton.showMotherDescriptionInput();
                            break;
                        case 9:
                            DNAButton.showAIChoices();
                            break;
                        case 10:
                        case 11:
                        case 12:
                            setTimeout(function() {
                                Conversation.moveToNextQuestion();
                            }, 2000);
                            break;
                        case 13:
                            setTimeout(function() {
                                Conversation.moveToNextQuestion();
                            }, 2000);
                            break;
                        case 14:
                            // Add 3 second delay after "hi there" message
                            setTimeout(function() {
                                DNAButton.showText('Na gut', 'Oh well');
                            }, 4000); // 1000ms + 3000ms delay
                            break;
                        default:
                            break;
                    }
                }, 1000);
            },

            completeCourse: function() {
                setTimeout(function() {
                    var buttons = document.querySelectorAll('button, .btn, [role="button"]');
                    for (var i = 0; i < buttons.length; i++) {
                        var btn = buttons[i];
                        var text = btn.textContent.toLowerCase();
                        if (text.indexOf('complete') !== -1 || text.indexOf('continue') !== -1 || text.indexOf('next') !== -1) {
                            btn.click();
                            return;
                        }
                    }
                }, 2000);
            },

            startFinalSequence: function() {
                var self = this;
                
                // Step 1: Analysing German language...
                setTimeout(function() {
                    DNAButton.showStatus('Analysing German language...');
                }, 500);
                
                // Step 2: Complexity counting
                setTimeout(function() {
                    self.showComplexityCounter();
                }, 2500);
                
                // Step 3: Subject surpassing AI capabilities + Play system error audio
                setTimeout(function() {
                    DNAButton.hideStatus();
                    
                    // Play system error audio immediately
                    setTimeout(function() {
                        console.log('🎵 Playing system error audio now...');
                        self.playSystemErrorAudio();
                    }, 100); // Small delay to ensure status is hidden
                    
                    setTimeout(function() {
                        DNAButton.showStatus('Subject surpassing AI capabilities', true);
                    }, 500);
                }, 8000);
                
                // Step 4: Falling back to Human Intelligence + Play human wakeup audio
                setTimeout(function() {
                    DNAButton.hideStatus();
                    
                    // Play human wakeup audio
                    setTimeout(function() {
                        console.log('🎵 Playing human wakeup audio...');
                        self.playHumanWakeupAudio();
                    }, 100);
                    
                    setTimeout(function() {
                        DNAButton.showStatus('Falling back to Human Intelligence');
                    }, 500);
                }, 10500);
                
                // Step 5: Show personality profile
                setTimeout(function() {
                    DNAButton.hideStatus();
                    setTimeout(function() {
                        DNAButton.showPersonalityProfile();
                    }, 1000);
                }, 13000);
                
                // Step 6: Dissolve transition after profile viewing
                setTimeout(function() {
                    self.dissolveAndTransition();
                }, 20000); // Give time to read the profile
            },

            playHumanWakeupAudio: function() {
                console.log('🔊 Attempting to play human wakeup audio...');
                
                var audio = new Audio(State.humanWakeupAudio);
                audio.volume = 0.8;
                audio.preload = 'auto';
                
                // Track audio element for cleanup
                window.audioElements = window.audioElements || [];
                window.audioElements.push(audio);
                
                audio.onloadeddata = function() {
                    console.log('✅ Human wakeup audio loaded successfully');
                };
                
                audio.onended = function() {
                    console.log('✅ Human wakeup audio completed');
                };
                
                audio.onerror = function(e) {
                    console.log('❌ Human wakeup audio failed:', e);
                };
                
                // Try to play immediately
                var playPromise = audio.play();
                if (playPromise !== undefined) {
                    playPromise.then(function() {
                        console.log('✅ Human wakeup audio started playing');
                    }).catch(function(e) {
                        console.log('❌ Human wakeup audio play failed:', e.message);
                        
                        // Fallback: try WebAudio if available
                        if (WebAudioHelper.isMobile && State.audioUnlocked && window.AudioContext) {
                            console.log('🔄 Trying WebAudio fallback for human wakeup...');
                            WebAudioHelper.play(
                                State.humanWakeupAudio,
                                function() {
                                    console.log('✅ Human wakeup audio completed via WebAudio');
                                },
                                function(e) {
                                    console.log('❌ Human wakeup audio WebAudio failed:', e.message);
                                }
                            );
                        }
                    });
                } else {
                    console.log('❌ Audio play promise not supported for human wakeup');
                }
            },

            playSystemErrorAudio: function() {
                console.log('🔊 Attempting to play system error audio...');
                
                var audio = new Audio(State.systemErrorAudio);
                audio.volume = 0.8;
                audio.preload = 'auto';
                
                audio.onloadeddata = function() {
                    console.log('✅ System error audio loaded successfully');
                };
                
                audio.onended = function() {
                    console.log('✅ System error audio completed');
                };
                
                audio.onerror = function(e) {
                    console.log('❌ System error audio failed:', e);
                };
                
                // Try to play immediately
                var playPromise = audio.play();
                if (playPromise !== undefined) {
                    playPromise.then(function() {
                        console.log('✅ System error audio started playing');
                    }).catch(function(e) {
                        console.log('❌ System error audio play failed:', e.message);
                        
                        // Fallback: try WebAudio if available
                        if (WebAudioHelper.isMobile && State.audioUnlocked && window.AudioContext) {
                            console.log('🔄 Trying WebAudio fallback...');
                            WebAudioHelper.play(
                                State.systemErrorAudio,
                                function() {
                                    console.log('✅ System error audio completed via WebAudio');
                                },
                                function(e) {
                                    console.log('❌ System error audio WebAudio failed:', e.message);
                                }
                            );
                        }
                    });
                } else {
                    console.log('❌ Audio play promise not supported');
                }
            },

            showComplexityCounter: function() {
                var statusDisplay = UI.element('statusDisplay');
                var visualizer = UI.element('visualizer');
                
                if (statusDisplay && visualizer) {
                    visualizer.classList.add('text-mode');
                    statusDisplay.classList.remove('error');
                    statusDisplay.classList.add('visible');
                    
                    var count = 0;
                    var interval = setInterval(function() {
                        count += Math.floor(Math.random() * 50) + 25; // Random increments
                        if (count >= 1000) {
                            clearInterval(interval);
                            statusDisplay.textContent = 'Complexity: ERROR';
                            statusDisplay.classList.add('error');
                        } else {
                            statusDisplay.textContent = 'Complexity: ' + count + '%';
                        }
                    }, 200);
                }
            },

            dissolveAndTransition: function() {
                var dissolveOverlay = UI.element('dissolveOverlay');
                
                if (dissolveOverlay) {
                    dissolveOverlay.classList.add('active');
                    
                    setTimeout(function() {
                        // Try to find and click course completion buttons
                        var buttons = document.querySelectorAll('button, .btn, [role="button"]');
                        for (var i = 0; i < buttons.length; i++) {
                            var btn = buttons[i];
                            var text = btn.textContent.toLowerCase();
                            if (text.indexOf('complete') !== -1 || text.indexOf('continue') !== -1 || text.indexOf('next') !== -1) {
                                btn.click();
                                return;
                            }
                        }
                        
                        // Fallback: Try to navigate to next page in course structure
                        window.location.href = window.location.href.replace(/\/lectures\/\d+/, function(match) {
                            var num = parseInt(match.split('/').pop()) + 1;
                            return '/lectures/' + num;
                        });
                    }, 3000);
                }
            },

            startQ1: function() {
                var isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                if (isMobile && State.mobileAudioStarted) return;
                
                UI.setVisualizerState('active');
                UI.updateProgress(5);
                State.step = 0;
                
                var url = State.audioFiles[0];
                UI.setVisualizerState('speaking');
                
                if (window.AudioContext && WebAudioHelper) {
                    WebAudioHelper.play(url, function() {
                        UI.setVisualizerState('active');
                        setTimeout(function() { 
                            DNAButton.showText('Bereit', 'Ready'); 
                        }, 2000);
                    }, function(e) {
                        UI.setVisualizerState('active');
                        setTimeout(function() { 
                            DNAButton.showText('Bereit', 'Ready'); 
                        }, 2000);
                    });
                } else {
                    var audio = AudioManager.createAudio(url);
                    audio.onended = function() {
                        UI.setVisualizerState('active');
                        setTimeout(function() { DNAButton.showText('Bereit', 'Ready'); }, 2000);
                    };
                    audio.onerror = function(e) {
                        UI.setVisualizerState('active');
                        setTimeout(function() { DNAButton.showText('Bereit', 'Ready'); }, 2000);
                    };
                    audio.play();
                }
            }
        };

        var SG1 = {
            musicEnabled: true,
            
            toggleMusic: function() {
                var music = UI.element('backgroundMusic');
                var musicButton = UI.element('musicButton');
                
                if (this.musicEnabled) {
                    if (music) music.pause();
                    if (musicButton) musicButton.classList.add('off');
                    this.musicEnabled = false;
                } else {
                    if (music) {
                        var playPromise = music.play();
                        if (playPromise) {
                            playPromise.then(function() {
                                console.log('Music resumed successfully');
                            }).catch(function(e) {
                                console.log('Music resume failed: ' + e.message);
                            });
                        }
                    }
                    if (musicButton) musicButton.classList.remove('off');
                    this.musicEnabled = true;
                }
            },
            
            beginInitialization: function() {
                var preInitButton = document.querySelector('.pre-init-button');
                if (preInitButton) {
                    preInitButton.style.transform = 'scale(0.95)';
                    preInitButton.style.opacity = '0.7';
                    preInitButton.textContent = 'Starting...';
                }
                
                // Hide control buttons during initialization
                var skipButton = UI.element('skipButton');
                var quitButton = UI.element('quitButton');
                var musicButton = UI.element('musicButton');
                if (skipButton) skipButton.style.display = 'none';
                if (quitButton) quitButton.style.display = 'none';
                if (musicButton) musicButton.style.display = 'none';
                
                var isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                
                var unlockAudio = AudioManager.createAudio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmMcBjiI2OvKcyMFl2+z9N2aPAIbWr9yxmAXGFnj8MJzJQUYYbf2xGIYG1nq6MJzJQUYlGt19Mhvaz5gXFztw2kdA0qP2uzGeTYFG3a36Pn0YlFmdXTs8bHnzLqLh6uYfJBaRoZ1puLsxXEvCSdtytNdKAkzWLz6qHNxMEOw6MtbKhJLkM/d3QBVL9JKR5X2QQAwfOYTM8cVkPB29ppqOZN17+o1GAbSrAXvOK9qVsO2P2bfyXU5aOPYqE+TKYeKc1PEJd+7L2XKHOd6d1qTKZ2pXPHZq36DWdF4VJOhJr6l9YNkFJdFaLyJRjF7X1lGf61O2FO8gY0n');
                unlockAudio.volume = 0.01;
                
                unlockAudio.play().then(function() {
                    State.audioUnlocked = true;
                    
                    try {
                        if (!window.globalAudioContext && window.AudioContext) {
                            window.globalAudioContext = new AudioContext();
                        }
                        if (window.globalAudioContext && window.globalAudioContext.state === 'suspended') {
                            window.globalAudioContext.resume();
                        }
                    } catch (e) {}
                }).catch(function(e) {
                    State.audioUnlocked = false;
                });
                
                var music = UI.element('backgroundMusic');
                if (music && SG1.musicEnabled) {
                    music.volume = 0.3;
                    music.play().catch(function(e) {
                        console.log('❌ Background music failed: ' + e.message);
                    });
                }
                
                if (isMobile) {
                    try {
                        var ctx = window.globalAudioContext || (window.AudioContext ? new AudioContext() : null);
                        if (ctx) {
                            var buffer = ctx.createBuffer(1, 1, 22050);
                            var source = ctx.createBufferSource();
                            source.buffer = buffer;
                            source.connect(ctx.destination);
                            source.start(0);
                        }
                    } catch (e) {}
                }
                
                setTimeout(function() {
                    try {
                        if (document.documentElement.requestFullscreen) {
                            document.documentElement.requestFullscreen().catch(function(e) {});
                        } else if (document.documentElement.webkitRequestFullscreen) {
                            document.documentElement.webkitRequestFullscreen();
                        } else if (document.documentElement.mozRequestFullScreen) {
                            document.documentElement.mozRequestFullScreen();
                        }
                    } catch (e) {}
                    
                    UI.hideElement('preInitOverlay');
                    UI.showElement('initOverlay');
                    
                    SG1.startInitialization();
                }, 300);
            },

            startInitialization: function() {
                var logo = document.querySelector('.init-logo');
                var status = UI.element('statusText');
                
                if (status) status.textContent = 'Audio system ready. Loading voice...';
                
                if (logo) {
                    logo.style.opacity = '0';
                    logo.style.animation = 'none';
                    logo.style.transform = 'translate(-50%, -50%) scale(0.8)';
                    
                    setTimeout(function() {
                        if (status) {
                            status.textContent = 'Voice system online. Starting sequence...';
                            setTimeout(function() {
                                status.style.transition = 'opacity 1s ease-out';
                                status.style.opacity = '0';
                            }, 2000);
                        }
                        
                        logo.style.animation = 'sg1LogoFade 16s ease-in-out forwards';
                        
                        setTimeout(function() {
                            if (logo.style.opacity === '0') {
                                logo.style.opacity = '1';
                                logo.style.transform = 'translate(-50%, -50%) scale(1)';
                                
                                setTimeout(function() {
                                    logo.style.opacity = '0';
                                }, 10000);
                            }
                        }, 3000);
                        
                        setTimeout(function() {
                            logo.style.opacity = '0';
                            logo.style.display = 'none';
                        }, 15000);
                        
                    }, 1000);
                }
                
                setTimeout(function() {
                    if (status) status.textContent = 'Loading neural interface...';
                    
                    // Add 1 second delay before showing DNA
                    setTimeout(function() {
                        UI.showElement('visualizer');
                        
                        var visualizer = UI.element('visualizer');
                        if (visualizer) {
                            visualizer.style.opacity = '0';
                            visualizer.style.transition = 'opacity 4s ease-in';
                            setTimeout(function() {
                                visualizer.style.opacity = '1';
                            }, 100);
                        }
                        
                        var isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                        if (isMobile && !State.mobileAudioStarted) {
                            setTimeout(function() {
                                var mobileVoiceAudio = new Audio(State.audioFiles[0]);
                                mobileVoiceAudio.volume = 1.0;
                                
                                var playPromise = mobileVoiceAudio.play();
                                if (playPromise) {
                                    playPromise.then(function() {
                                        State.isSpeaking = true;
                                        State.step = 0;
                                        State.mobileAudioStarted = true;
                                        UI.setVisualizerState('speaking');
                                        
                                        mobileVoiceAudio.onended = function() {
                                            State.isSpeaking = false;
                                            UI.setVisualizerState('active');
                                            setTimeout(function() { 
                                                DNAButton.showText('Bereit', 'Ready'); 
                                            }, 1000);
                                        };
                                    }).catch(function(e) {});
                                }
                            }, 4100);
                        }
                    }, 1000); // 1 second delay
                }, 15000);

                setTimeout(function() {
                    if (status) status.textContent = 'Ready to begin...';
                    UI.hideElement('initOverlay');
                    
                    setTimeout(function() {
                        Conversation.startQ1();
                    }, 500);
                }, 18000);
            },

            init: function() {
                console.log('SG1 initialized');
            }
        };

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                SG1.init();
            });
        } else {
            SG1.init();
        }

        window.onerror = function(message, source, lineno, colno, error) {
            console.log('ERROR: ' + message + ' at line ' + lineno);
            return false;
        };
</script>
</body>
</html>