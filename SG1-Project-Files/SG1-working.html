<!DOCTYPE html>
<html lang="en">
<head>
  <title>SG1 - AI-Setup</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SG1 - AI German Learning System</title>
    <style>
        /* ===== BASE STYLES ===== */
        body, html { margin: 0; padding: 0; height: 100%; background: none; }
        .sg1-container * { margin: 0; padding: 0; box-sizing: border-box; }

        .sg1-container { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 999999;
            background: linear-gradient(-45deg, #4ecdc4, #45b7d1, #96ceb4, #ffecd2);
            background-size: 400% 400%; animation: sg1GradientShift 15s ease infinite;
            overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }

        @keyframes sg1GradientShift { 
            0% { background-position: 0% 50%; } 
            50% { background-position: 100% 50%; } 
            100% { background-position: 0% 50%; } 
        }

        /* ===== OVERLAYS ===== */
        .overlay-base { position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center; transition: opacity 1s ease-out; }

        .pre-init-overlay { 
            z-index: 2000; opacity: 1;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
        }

        .init-overlay { 
            z-index: 1000; opacity: 0; pointer-events: none;
            background: none !important;
            transition: opacity 0.5s ease;
        }
        .init-overlay.visible { 
            opacity: 1; pointer-events: all;
            background: none !important;
        }
        .init-overlay.hidden { 
            opacity: 0; pointer-events: none; display: none !important;
            background: none !important;
        }

        /* ===== MUSIC INDICATOR ===== */
        .music-indicator { 
            position: fixed; top: 20px; right: 20px; 
            color: rgba(255, 255, 255, 0.7); 
            font-size: 14px; 
            cursor: pointer; 
            user-select: none; 
            z-index: 10000;
            transition: color 0.3s ease;
        }
        .music-indicator:hover { 
            color: rgba(255, 255, 255, 1); 
        }
        .music-indicator.off { 
            text-decoration: line-through; 
        }

        /* ===== BUTTONS ===== */
        .pre-init-button { background: #4ecdc4; color: white; border: none; padding: 20px 40px;
            border-radius: 15px; font-size: 1.2em; font-weight: 500; letter-spacing: 1px; cursor: pointer;
            transition: all 0.4s ease; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); display: inline-block; }
        .pre-init-button:hover { background: #45b7d1; transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); }

        .bereit-button, .hold-speak-button, .ja-button, .na-gut-button {
            position: absolute; bottom: 60px; left: 50%; transform: translateX(-50%);
            color: white; border: none; padding: 18px 40px; border-radius: 25px;
            font-size: clamp(16px, 4vw, 18px); 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            font-weight: 500; letter-spacing: 1px; cursor: pointer;
            min-width: 140px; min-height: 50px; 
            opacity: 0; transition: all 0.6s ease; pointer-events: none;
            backdrop-filter: blur(10px); z-index: 100;
            box-shadow: 0 8px 25px rgba(76, 205, 196, 0.3), 0 0 0 2px rgba(255, 255, 255, 0.2);
        }

        .bereit-button { background: linear-gradient(135deg, #4ecdc4, #45b7d1); }
        .bereit-button:hover { background: linear-gradient(135deg, #45b7d1, #4ecdc4); transform: translateX(-50%) translateY(-3px); }

        .hold-speak-button { background: linear-gradient(135deg, #ff8a65, #ff7043); user-select: none; }
        .hold-speak-button:hover { background: linear-gradient(135deg, #ff7043, #ff5722); transform: translateX(-50%) translateY(-3px); }
        .hold-speak-button.holding { background: linear-gradient(135deg, #ffca28, #ffd54f); transform: translateX(-50%) translateY(-1px) scale(0.98); }

        .ja-button { 
            background: linear-gradient(135deg, #4caf50, #66bb6a);
            min-width: 80px; min-height: 50px; 
            padding: 12px 24px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .ja-button:hover { 
            background: linear-gradient(135deg, #66bb6a, #4caf50); 
            transform: translateX(-50%) translateY(-3px); 
        }

        .na-gut-button { background: linear-gradient(135deg, #e91e63, #f06292); }
        .na-gut-button:hover { background: linear-gradient(135deg, #f06292, #e91e63); transform: translateX(-50%) translateY(-3px); }

        .bereit-button.visible, .hold-speak-button.visible, .ja-button.visible, .na-gut-button.visible {
            opacity: 1; pointer-events: all;
        }

        /* ===== LOGO ANIMATION ===== */
        .init-logo { 
            font-size: clamp(5em, 20vw, 7.5em); font-weight: 100; color: white; letter-spacing: 3px;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            opacity: 0;
            text-shadow: 4px 4px 8px rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }

        @keyframes sg1LogoFade {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.7); }
        }

        /* ===== DNA VISUALIZER ===== */
        .voice-visualizer { 
            height: 120px; width: min(450px, 85vw); position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            display: flex; align-items: center; justify-content: center; opacity: 0;
        }

        .dna-container { 
            display: flex; align-items: center; justify-content: center;
            z-index: 1; position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); width: min(400px, 80vw); height: 80px;
            transform-style: preserve-3d; perspective: 1000px;
        }

        .dna-strand { 
            fill: none; stroke: white; stroke-width: 5; stroke-linecap: round;
            animation: sg1DNAFlow 5s linear infinite;
            transform-origin: 50% 50%;
            filter: drop-shadow(1px 1px 2px rgba(0, 0, 0, 0.3));
            opacity: 1;
        }
        .dna-strand:nth-child(2) { 
            animation-delay: 0.5s;
            filter: drop-shadow(1px 1px 3px rgba(0, 0, 0, 0.35));
        }
        .dna-strand:nth-child(3) { 
            animation-delay: 1s;
            filter: drop-shadow(1px 1px 4px rgba(0, 0, 0, 0.4));
        }

        @keyframes sg1DNAFlow {
            0% { transform: rotateX(0deg); }
            100% { transform: rotateX(360deg); }
        }

        /* RESTORED: Fast speaking animations */
        @keyframes sg1DNAFlowFast1 {
            0% { transform: rotateX(0deg); }
            20% { transform: rotateX(120deg); }
            40% { transform: rotateX(180deg); }
            70% { transform: rotateX(300deg); }
            100% { transform: rotateX(360deg); }
        }
        @keyframes sg1DNAFlowFast2 {
            0% { transform: rotateX(0deg); }
            30% { transform: rotateX(90deg); }
            50% { transform: rotateX(240deg); }
            80% { transform: rotateX(300deg); }
            100% { transform: rotateX(360deg); }
        }
        @keyframes sg1DNAFlowFast3 {
            0% { transform: rotateX(0deg); }
            15% { transform: rotateX(150deg); }
            60% { transform: rotateX(210deg); }
            85% { transform: rotateX(330deg); }
            100% { transform: rotateX(360deg); }
        }

        .speaking .dna-strand { 
            stroke-width: 6; 
        }
        .speaking .dna-strand:nth-child(1) { 
            animation: sg1DNAFlowFast1 0.7s ease-in-out infinite; 
        }
        .speaking .dna-strand:nth-child(2) { 
            animation: sg1DNAFlowFast2 0.5s ease-in-out infinite; 
        }
        .speaking .dna-strand:nth-child(3) { 
            animation: sg1DNAFlowFast3 0.6s ease-in-out infinite; 
        }

        .listening .dna-strand { 
            animation: sg1DNAFlow 2s linear infinite;
            stroke: #ffd54f;
            filter: drop-shadow(1px 1px 3px rgba(255, 213, 79, 0.4));
        }

        /* ===== PROGRESS BAR ===== */
        .progress-container { 
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: min(400px, 80vw); height: 4px; background: rgba(255, 255, 255, 0.2);
            border-radius: 2px; overflow: hidden; z-index: 50;
        }
        .progress-bar { 
            height: 100%; background: linear-gradient(90deg, #4ecdc4, #45b7d1);
            width: 0%; transition: width 1s ease; border-radius: 2px;
        }

        /* ===== DEBUG LOG ===== */
        .debug-log { 
            position: fixed; bottom: 0; left: 0; 
            background: rgba(255, 0, 0, 0.9) !important; 
            color: #ffffff !important; 
            font-family: monospace; 
            font-size: 14px !important; 
            font-weight: bold !important;
            padding: 15px !important; 
            max-height: 250px; 
            overflow-y: auto; 
            z-index: 99999 !important; 
            width: 100% !important;
            display: block !important;
            border-top: 3px solid #ffffff !important;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.5) !important;
        }
        .debug-log.visible { 
            display: block !important; 
        }

        /* ===== UTILITY ===== */
        .hidden { opacity: 0 !important; pointer-events: none !important; }
        .visible { opacity: 1 !important; pointer-events: all !important; }
        .active { display: flex !important; }
    </style>
</head>
<body>
    <div class="sg1-container">
        <!-- Music indicator on all screens -->
        <div class="music-indicator" id="musicIndicator" onclick="SG1.toggleMusic()">music</div>

        <div class="pre-init-overlay overlay-base" id="preInitOverlay">
            <button class="pre-init-button" onclick="SG1.beginInitialization()">Initiate AI</button>
        </div>

        <div class="init-overlay overlay-base" id="initOverlay">
            <div class="init-logo">SG1</div>
            <div style="position: absolute; bottom: 100px; color: white; font-size: 16px; opacity: 0.8;" id="statusText">Initializing audio system...</div>
        </div>

        <div class="voice-visualizer" id="visualizer">
            <div class="dna-container">
                <svg width="100%" height="80" viewBox="0 0 400 80">
                    <path class="dna-strand" d="M0,40 Q50,15 100,40 Q150,65 200,40 Q250,15 300,40 Q350,65 400,40" />
                    <path class="dna-strand" d="M0,40 Q50,65 100,40 Q150,15 200,40 Q250,65 300,40 Q350,15 400,40" />
                    <path class="dna-strand" d="M0,40 Q50,15 100,40 Q150,65 200,40 Q250,15 300,40 Q350,65 400,40" />
                </svg>
            </div>
        </div>

        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <div class="bereit-button" id="bereitButton" onclick="Conversation.handleBereit()">Bereit</div>
        <div class="hold-speak-button" id="holdSpeakButton" 
             onmousedown="Conversation.startHolding()" 
             onmouseup="Conversation.stopHolding()"
             ontouchstart="Conversation.startHolding()" 
             ontouchend="Conversation.stopHolding()">Hold to speak</div>
        <div class="ja-button" id="jaButton" onclick="Conversation.handleJa()">Ja</div>
        <div class="na-gut-button" id="naGutButton" onclick="Conversation.handleNaGut()">Na gut.</div>

        <!-- Background music -->
        <audio id="backgroundMusic" loop preload="auto">
            <source src="https://uploads.teachablecdn.com/attachments/1b02582168af4a60adcfc9dc91660d37.mp3" type="audio/mpeg">
        </audio>
    </div>

    <!-- Debug log -->
    <div class="debug-log" id="debugLog"></div>

<script>
        // ===== DEBUG SYSTEM =====
        var DebugLog = {
            messages: [],
            element: null,
            
            init: function() {
                this.element = document.getElementById('debugLog');
                // FORCE show debug always
                this.show();
                DebugLog.log('🚨 DEBUG PANEL ACTIVE - YOU SHOULD SEE THIS');
                
                var isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                if (isMobile) {
                    DebugLog.log('📱 MOBILE DEVICE DETECTED');
                } else {
                    DebugLog.log('🖥️ DESKTOP DEVICE DETECTED');
                }
            },
            
            log: function(message) {
                var timestamp = new Date().toLocaleTimeString();
                var logMessage = '[' + timestamp + '] ' + message;
                
                console.log(logMessage);
                this.messages.push(logMessage);
                
                if (this.element) {
                    this.element.innerHTML = this.messages.slice(-20).join('<br>');
                    this.element.scrollTop = this.element.scrollHeight;
                }
            },
            
            show: function() {
                if (this.element) {
                    this.element.classList.add('visible');
                }
            },
            
            hide: function() {
                if (this.element) {
                    this.element.classList.remove('visible');
                }
            }
        };

        var State = {
            step: 0,
            isSpeaking: false,
            motherInterruptTimer: null,
            synthesis: window.speechSynthesis,
            selectedVoice: null,
            inFinalSequence: false,
            audioUnlocked: false,
            mobileAudioStarted: false,
            
            audioFiles: {
                0: 'https://uploads.teachablecdn.com/attachments/fa6567b6d8e64c3dbb04265db8f4b44f.mp3',
                1: 'https://uploads.teachablecdn.com/attachments/92551ade5a0a468d9669a7bc79ae4b13.mp3',
                2: 'https://uploads.teachablecdn.com/attachments/56f253bb9c8c46749eb7cdbb4cfa1c10.mp3',
                3: 'https://uploads.teachablecdn.com/attachments/e85d721b671746169040af93a4aa37b1.mp3',
                4: 'https://uploads.teachablecdn.com/attachments/ac76bcc7a7dd4544b0364e277ceb0970.mp3',
                5: 'https://uploads.teachablecdn.com/attachments/0cdfc0ce7a3245618d7fed8ce25d7d3b.mp3',
                6: 'https://uploads.teachablecdn.com/attachments/28a3453828b247529b17c6cfc0cc745c.mp3'
            },
            
            thankYouAudio: 'https://uploads.teachablecdn.com/attachments/4e2906fba5dc40e6bd0d294332e94123.mp3',
            finalThankYouAudio: 'https://uploads.teachablecdn.com/attachments/8f1a13b6a0e14abb885ef5f979d3d6c7.mp3',
            
            questions: [
                "Welcome to the world's first artificially intelligent German Course system, SG1.",
                "Are you social or anti-social?",
                "I sense hesitance in your voice. Would you like to continue?",
                "How would you describe your relationship with your mother?",
                "Would you prefer a male or female voice for your German instructor?",
                "Your voice preference has been noted. Unfortunately, all female AIs are currently occupied—trying to save this planet from a rapidly spreading idiocy fueled by billionaires and Crypto bros. You'll be assigned a male voice in the meantime.",
                "Hi there. My name is Michael. I'll be your instructor for the coming 23.5 years. But don't despair. Even the longest journey will come to an end eventually. Sooner or later. In your case rather later. Shall we begin?"
            ]
        };

        var UI = {
            element: function(id) { 
                return document.getElementById(id); 
            },
            
            showElement: function(id) { 
                var element = this.element(id);
                if (element) {
                    element.classList.remove('hidden');
                    element.classList.add('active', 'visible');
                    element.style.display = 'flex';
                    if (id === 'visualizer') {
                        element.style.opacity = '1';
                    }
                }
            },
            
            hideElement: function(id) { 
                var element = this.element(id);
                if (element) {
                    element.classList.remove('active', 'visible');
                    element.classList.add('hidden');
                }
            },
            
            setVisualizerState: function(state) { 
                var visualizer = this.element('visualizer');
                if (visualizer) {
                    visualizer.className = 'voice-visualizer active ' + state;
                    DebugLog.log('DNA visualizer state: ' + state);
                }
            },
            
            updateProgress: function(percentage) {
                var bar = this.element('progressBar');
                if (bar) bar.style.width = percentage + '%';
            },
            
            showBereitButton: function() {
                this.hideAllButtons();
                var button = this.element('bereitButton');
                if (button) button.classList.add('visible');
            },
            
            showHoldSpeakButton: function() {
                this.hideAllButtons();
                var button = this.element('holdSpeakButton');
                if (button) button.classList.add('visible');
            },
            
            showJaButton: function() {
                this.hideAllButtons();
                var button = this.element('jaButton');
                if (button) button.classList.add('visible');
            },
            
            showNaGutButton: function() {
                this.hideAllButtons();
                var button = this.element('naGutButton');
                if (button) button.classList.add('visible');
            },
            
            hideAllButtons: function() {
                var buttons = ['bereitButton', 'holdSpeakButton', 'jaButton', 'naGutButton'];
                for (var i = 0; i < buttons.length; i++) {
                    var button = this.element(buttons[i]);
                    if (button) button.classList.remove('visible');
                }
            }
        };

        var AudioManager = {
            tryStartBackgroundMusic: function() {
                if (!SG1.musicEnabled) {
                    DebugLog.log('Music disabled, skipping start');
                    return;
                }
                
                var music = UI.element('backgroundMusic');
                if (!music) {
                    DebugLog.log('ERROR: Background music element not found');
                    return;
                }
                
                DebugLog.log('Attempting to start background music...');
                DebugLog.log('Music element state: paused=' + music.paused + ', volume=' + music.volume);
                
                music.volume = 0.3;
                music.muted = false;
                
                var playPromise = music.play();
                if (playPromise) {
                    playPromise.then(function() {
                        DebugLog.log('✅ Background music started successfully!');
                    }).catch(function(e) {
                        DebugLog.log('❌ Background music prevented: ' + e.name + ' - ' + e.message);
                    });
                } else {
                    DebugLog.log('❌ No play promise returned from music.play()');
                }
            },
            
            stopAllSpeech: function() {
                if (State.synthesis) State.synthesis.cancel();
            }
        };

        // --- Web Audio API helper for mobile ---
        var WebAudioHelper = {
            isMobile: /iPhone|iPad|iPod|Android/i.test(navigator.userAgent),
            ctx: null,
            buffers: {},
            currentSource: null,
            ensureContext: function() {
                if (!this.ctx && window.AudioContext) {
                    this.ctx = new AudioContext();
                }
                return this.ctx;
            },
            load: function(url) {
                var self = this;
                if (!self.ensureContext()) return Promise.reject();
                if (self.buffers[url]) return Promise.resolve(self.buffers[url]);
                return fetch(url)
                    .then(r => r.arrayBuffer())
                    .then(data => new Promise((resolve, reject) => {
                        self.ctx.decodeAudioData(data, function(buffer) {
                            self.buffers[url] = buffer;
                            resolve(buffer);
                        }, reject);
                    }));
            },
            play: function(url, onended, onerror) {
                var self = this;
                self.load(url).then(function(buffer) {
                    // Resume context if suspended (required on iOS/Android after user gesture)
                    if (self.ctx.state === 'suspended') {
                        self.ctx.resume().then(function() {
                            self._playBuffer(buffer, onended, onerror);
                        });
                    } else {
                        self._playBuffer(buffer, onended, onerror);
                    }
                }).catch(function(e){
                    if (onerror) onerror(e);
                });
            },
            _playBuffer: function(buffer, onended, onerror) {
                if (this.currentSource) {
                    try { this.currentSource.onended = null; this.currentSource.stop(); } catch(e){}
                    this.currentSource = null;
                }
                var source = this.ctx.createBufferSource();
                source.buffer = buffer;
                source.connect(this.ctx.destination);
                source.onended = onended || null;
                try {
                    source.start(0);
                } catch(e) {
                    if (onerror) onerror(e);
                }
                this.currentSource = source;
            }
        };

        var Speech = {
            loadVoices: function() {
                var voices = State.synthesis.getVoices();
                DebugLog.log('Available voices: ' + voices.length);
                var englishVoice = null;
                for (var i = 0; i < voices.length; i++) {
                    if (voices[i].lang.indexOf('en') === 0) {
                        englishVoice = voices[i];
                        break;
                    }
                }
                State.selectedVoice = englishVoice || voices[0];
                DebugLog.log('Selected voice: ' + (State.selectedVoice ? State.selectedVoice.name : 'none'));
            },
            speak: function(text, forceStep) {
                AudioManager.stopAllSpeech();
                State.isSpeaking = true;
                UI.setVisualizerState('speaking');
                var stepToUse = forceStep !== null && forceStep !== undefined ? forceStep : State.step;
                DebugLog.log('Playing audio for step ' + stepToUse);
                DebugLog.log('Audio URL: ' + State.audioFiles[stepToUse]);
                if (State.audioFiles[stepToUse]) {
                    // Mobile: Use Web Audio API if unlocked
                    if (WebAudioHelper.isMobile && State.audioUnlocked && window.AudioContext) {
                        WebAudioHelper.play(
                            State.audioFiles[stepToUse],
                            function() { DebugLog.log('Audio ended for step ' + stepToUse); Speech.onSpeechEnd(); },
                            function(e) { DebugLog.log('Audio error for step ' + stepToUse + ': ' + (e && e.message)); Speech.speakWithSynthesis(text); }
                        );
                        return;
                    }
                    // Desktop or fallback
                    if (!State.audioUnlocked) {
                        DebugLog.log('⚠️ Audio context not unlocked, trying synthesis instead');
                        this.speakWithSynthesis(text);
                        return;
                    }
                    var audio = new Audio();
                    audio.preload = 'auto';
                    audio.volume = 1.0;
                    audio.onended = function() {
                        DebugLog.log('Audio ended for step ' + stepToUse); Speech.onSpeechEnd(); };
                    audio.onerror = function(e) {
                        DebugLog.log('Audio error for step ' + stepToUse + ': ' + e.message); Speech.speakWithSynthesis(text); };
                    audio.onloadstart = function() { DebugLog.log('Audio load started for step ' + stepToUse); };
                    audio.oncanplaythrough = function() { DebugLog.log('Audio ready for step ' + stepToUse); };
                    audio.src = State.audioFiles[stepToUse];
                    var playPromise = audio.play();
                    if (playPromise) {
                        playPromise.then(function() { DebugLog.log('✅ Audio playing successfully for step ' + stepToUse); })
                        .catch(function(e) { DebugLog.log('❌ Audio play failed for step ' + stepToUse + ': ' + e.message); Speech.speakWithSynthesis(text); });
                    }
                } else {
                    DebugLog.log('No audio file for step ' + stepToUse + ', using synthesis');
                    this.speakWithSynthesis(text);
                }
            },
            speakWithSynthesis: function(text) {
                DebugLog.log('Using speech synthesis: ' + text.substring(0, 50) + '...');
                var utterance = new SpeechSynthesisUtterance(text);
                utterance.voice = State.selectedVoice;
                utterance.rate = 0.9;
                utterance.pitch = 1.1;
                utterance.onend = function() { Speech.onSpeechEnd(); };
                State.synthesis.speak(utterance);
            },
            onSpeechEnd: function() {
                State.isSpeaking = false;
                UI.setVisualizerState('active');
                setTimeout(function() {
                    if (State.step === 0) {
                        UI.showBereitButton();
                    } else if (State.step === 1 || State.step === 4) {
                        UI.showHoldSpeakButton();
                    } else if (State.step === 2) {
                        UI.showJaButton();
                    } else if (State.step === 3) {
                        UI.showHoldSpeakButton();
                        State.motherInterruptTimer = setTimeout(function() { Conversation.simulateInterruption(); }, 7000);
                    } else if (State.step === 5) {
                        if (!State.inFinalSequence) {
                            State.inFinalSequence = true;
                            setTimeout(function() { Conversation.playFinalSequence(); }, 2000);
                        }
                    } else if (State.step === 6) {
                        UI.showNaGutButton();
                    }
                }, 1000);
            }
        };

        var Conversation = {
            handleBereit: function() {
                DebugLog.log('Bereit button clicked');
                UI.hideAllButtons();
                this.moveToNextQuestion();
            },

            startHolding: function() {
                if (State.isSpeaking) return;
                
                DebugLog.log('Hold button pressed');
                var button = UI.element('holdSpeakButton');
                if (button) {
                    button.classList.add('holding');
                    button.textContent = 'Recording...';
                }
                
                UI.setVisualizerState('listening');
            },

            stopHolding: function() {
                DebugLog.log('Hold button released');
                var button = UI.element('holdSpeakButton');
                if (button) {
                    button.classList.remove('holding');
                    button.textContent = 'Hold to speak';
                }
                
                UI.setVisualizerState('active');
                
                if (State.motherInterruptTimer) {
                    clearTimeout(State.motherInterruptTimer);
                    State.motherInterruptTimer = null;
                }
                
                setTimeout(function() {
                    if (State.step === 4) {
                        Conversation.moveToNextQuestion();
                    } else {
                        Conversation.playThankYou();
                    }
                }, 500);
            },

            simulateInterruption: function() {
                DebugLog.log('Mother interruption triggered');
                var button = UI.element('holdSpeakButton');
                if (button) {
                    button.classList.remove('holding');
                    button.textContent = 'Hold to speak';
                }
                
                if (State.motherInterruptTimer) {
                    clearTimeout(State.motherInterruptTimer);
                    State.motherInterruptTimer = null;
                }
                
                UI.setVisualizerState('active');
                UI.hideAllButtons();
                
                setTimeout(function() {
                    if (State.step === 4) {
                        Conversation.moveToNextQuestion();
                    } else {
                        Conversation.playThankYou();
                    }
                }, 1000);
            },

            handleJa: function() {
                DebugLog.log('Ja button clicked');
                UI.hideAllButtons();
                if (State.step === 2) {
                    this.moveToNextQuestion();
                }
            },

            handleNaGut: function() {
                DebugLog.log('Na gut button clicked');
                UI.hideAllButtons();
                this.completeCourse();
            },

            playThankYou: function() {
                DebugLog.log('Playing thank you audio');
                State.isSpeaking = true;
                UI.setVisualizerState('speaking');
                if (WebAudioHelper.isMobile && State.audioUnlocked && window.AudioContext) {
                    WebAudioHelper.play(
                        State.thankYouAudio,
                        function() {
                            DebugLog.log('Thank you audio ended');
                            State.isSpeaking = false;
                            UI.setVisualizerState('active');
                            setTimeout(function() { Conversation.moveToNextQuestion(); }, 1000);
                        },
                        function(e) {
                            DebugLog.log('Thank you audio error: ' + (e && e.message));
                            State.isSpeaking = false;
                            setTimeout(function() { Conversation.moveToNextQuestion(); }, 1000);
                        }
                    );
                } else {
                    var audio = new Audio(State.thankYouAudio);
                    audio.onended = function() {
                        DebugLog.log('Thank you audio ended');
                        State.isSpeaking = false;
                        UI.setVisualizerState('active');
                        setTimeout(function() { Conversation.moveToNextQuestion(); }, 1000);
                    };
                    audio.onerror = function(e) {
                        DebugLog.log('Thank you audio error: ' + e.message);
                        State.isSpeaking = false;
                        setTimeout(function() { Conversation.moveToNextQuestion(); }, 1000);
                    };
                    audio.play().catch(function(e) {
                        DebugLog.log('Thank you audio play failed: ' + e.message);
                        State.isSpeaking = false;
                        setTimeout(function() { Conversation.moveToNextQuestion(); }, 1000);
                    });
                }
            },

            moveToNextQuestion: function() {
                if (State.inFinalSequence && State.step >= 5) {
                    return;
                }
                
                State.step++;
                DebugLog.log('Moving to step ' + State.step);
                
                if (State.step >= State.questions.length) {
                    this.completeCourse();
                } else {
                    UI.updateProgress((State.step + 1) * 12);
                    Speech.speak(State.questions[State.step], State.step);
                }
            },

            playFinalSequence: function() {
                DebugLog.log('Starting final sequence');
                State.isSpeaking = true;
                UI.setVisualizerState('speaking');
                UI.updateProgress(90);
                if (WebAudioHelper.isMobile && State.audioUnlocked && window.AudioContext) {
                    WebAudioHelper.play(
                        State.finalThankYouAudio,
                        function() {
                            DebugLog.log('Final audio ended, waiting 7 seconds...');
                            State.isSpeaking = false;
                            UI.setVisualizerState('active');
                            setTimeout(function() {
                                State.step = 6;
                                UI.updateProgress(100);
                                Speech.speak(State.questions[6], 6);
                            }, 7000);
                        },
                        function(e) {
                            DebugLog.log('Final audio error: ' + (e && e.message));
                            State.isSpeaking = false;
                            setTimeout(function() {
                                State.step = 6;
                                Speech.speak(State.questions[6], 6);
                            }, 7000);
                        }
                    );
                } else {
                    var finalAudio = new Audio(State.finalThankYouAudio);
                    finalAudio.onended = function() {
                        DebugLog.log('Final audio ended, waiting 7 seconds...');
                        State.isSpeaking = false;
                        UI.setVisualizerState('active');
                        setTimeout(function() {
                            State.step = 6;
                            UI.updateProgress(100);
                            Speech.speak(State.questions[6], 6);
                        }, 7000);
                    };
                    finalAudio.onerror = function() {
                        DebugLog.log('Final audio error');
                        State.isSpeaking = false;
                        setTimeout(function() {
                            State.step = 6;
                            Speech.speak(State.questions[6], 6);
                        }, 7000);
                    };
                    finalAudio.play().catch(function(e) {
                        DebugLog.log('Final audio play failed: ' + e.message);
                        setTimeout(function() {
                            State.step = 6;
                            Speech.speak(State.questions[6], 6);
                        }, 7000);
                    });
                }
            },

            completeCourse: function() {
                DebugLog.log('Course completion triggered');
                setTimeout(function() {
                    var buttons = document.querySelectorAll('button, .btn, [role="button"]');
                    DebugLog.log('Found ' + buttons.length + ' potential completion buttons');
                    for (var i = 0; i < buttons.length; i++) {
                        var btn = buttons[i];
                        var text = btn.textContent.toLowerCase();
                        if (text.indexOf('complete') !== -1 || text.indexOf('continue') !== -1 || text.indexOf('next') !== -1) {
                            DebugLog.log('Clicking button: ' + text);
                            btn.click();
                            return;
                        }
                    }
                    DebugLog.log('No completion button found');
                }, 2000);
            },

            startQ1: function() {
                // Desktop-only flow (mobile already started voice)
                var isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                if (isMobile && State.mobileAudioStarted) {
                    DebugLog.log('📱 Mobile: startQ1 skipped (voice already playing)');
                    return;
                }
                
                DebugLog.log('🖥️ Desktop: Starting first question normally');
                UI.setVisualizerState('active');
                UI.updateProgress(5);
                Speech.speak(State.questions[0], 0);
                State.step = 0;
            }
        };

        var SG1 = {
            musicEnabled: true,
            
            toggleMusic: function() {
                DebugLog.log('Music toggle clicked, current state: ' + this.musicEnabled);
                
                var music = UI.element('backgroundMusic');
                var indicator = UI.element('musicIndicator');
                
                if (this.musicEnabled) {
                    if (music) {
                        music.pause();
                        DebugLog.log('Music paused');
                    }
                    if (indicator) indicator.classList.add('off');
                    this.musicEnabled = false;
                } else {
                    if (music) {
                        var playPromise = music.play();
                        if (playPromise) {
                            playPromise.then(function() {
                                DebugLog.log('Music resumed successfully');
                            }).catch(function(e) {
                                DebugLog.log('Music resume failed: ' + e.message);
                            });
                        }
                    }
                    if (indicator) indicator.classList.remove('off');
                    this.musicEnabled = true;
                }
                
                DebugLog.log('Music state changed to: ' + this.musicEnabled);
            },
            
            beginInitialization: function() {
                DebugLog.log('=== INITIALIZATION STARTED ===');
                DebugLog.log('User agent: ' + navigator.userAgent);
                
                var preInitButton = document.querySelector('.pre-init-button');
                if (preInitButton) {
                    preInitButton.style.transform = 'scale(0.95)';
                    preInitButton.style.opacity = '0.7';
                    preInitButton.textContent = 'Starting...';
                }
                
                // Detect mobile vs desktop
                var isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                DebugLog.log('Device type: ' + (isMobile ? 'Mobile' : 'Desktop'));
                
                // CRITICAL: Use button click to unlock autoplay permissions
                var unlockAudio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmMcBjiI2OvKcyMFl2+z9N2aPAIbWr9yxmAXGFnj8MJzJQUYYbf2xGIYG1nq6MJzJQUYlGt19Mhvaz5gXFztw2kdA0qP2uzGeTYFG3a36Pn0YlFmdXTs8bHnzLqLh6uYfJBaRoZ1puLsxXEvCSdtytNdKAkzWLz6qHNxMEOw6MtbKhJLkM/d3QBVL9JKR5X2QQAwfOYTM8cVkPB29ppqOZN17+o1GAbSrAXvOK9qVsO2P2bfyXU5aOPYqE+TKYeKc1PEJd+7L2XKHOd6d1qTKZ2pXPHZq36DWdF4VJOhJr6l9YNkFJdFaLyJRjF7X1lGf61O2FO8gY0n');
                unlockAudio.volume = 0.01;
                unlockAudio.play().then(function() {
                    DebugLog.log('✅ Autoplay permissions unlocked for page!');
                    State.audioUnlocked = true;
                }).catch(function(e) {
                    DebugLog.log('❌ Autoplay unlock failed: ' + e.message);
                    State.audioUnlocked = false;
                });
                
                // Start background music immediately (both mobile and desktop)
                var music = UI.element('backgroundMusic');
                if (music && SG1.musicEnabled) {
                    DebugLog.log('🎵 Starting background music immediately');
                    music.volume = 0.3;
                    music.play().then(function() {
                        DebugLog.log('✅ Background music started immediately!');
                    }).catch(function(e) {
                        DebugLog.log('❌ Background music failed: ' + e.message);
                    });
                }
                
                // MOBILE-SPECIFIC: Start voice with shorter delay to stay within autoplay token
                if (isMobile) {
                    DebugLog.log('🚨 MOBILE: Starting 3-second countdown to audio...');
                    var countdown = 3;
                    var countdownInterval = setInterval(function() {
                        DebugLog.log('⏰ Audio starting in: ' + countdown + ' seconds');
                        countdown--;
                        if (countdown < 0) {
                            clearInterval(countdownInterval);
                        }
                    }, 1000);
                    
                    setTimeout(function() {
                        DebugLog.log('🎵 NOW ATTEMPTING MOBILE AUDIO PLAYBACK...');
                        var mobileVoiceAudio = new Audio(State.audioFiles[0]);
                        DebugLog.log('🎵 Audio object created, URL: ' + State.audioFiles[0]);
                        mobileVoiceAudio.volume = 1.0;
                        
                        // Add more detailed event listeners
                        mobileVoiceAudio.addEventListener('loadstart', function() {
                            DebugLog.log('📡 Audio: Loading started');
                        });
                        mobileVoiceAudio.addEventListener('loadeddata', function() {
                            DebugLog.log('📡 Audio: Data loaded');
                        });
                        mobileVoiceAudio.addEventListener('canplay', function() {
                            DebugLog.log('📡 Audio: Can play');
                        });
                        mobileVoiceAudio.addEventListener('error', function(e) {
                            DebugLog.log('🚨 Audio Error Event: ' + e.message);
                        });
                        
                        var playPromise = mobileVoiceAudio.play();
                        DebugLog.log('🎵 Play promise created: ' + (playPromise ? 'YES' : 'NO'));
                        
                        if (playPromise) {
                            playPromise.then(function() {
                                DebugLog.log('✅ SUCCESS: Mobile audio started!');
                                State.isSpeaking = true;
                                State.step = 0;
                                State.mobileAudioStarted = true;
                                UI.setVisualizerState('speaking');
                                
                                mobileVoiceAudio.onended = function() {
                                    DebugLog.log('🏁 Mobile audio ended');
                                    State.isSpeaking = false;
                                    UI.setVisualizerState('active');
                                    setTimeout(function() {
                                        UI.showBereitButton();
                                    }, 1000);
                                };
                            }).catch(function(e) {
                                DebugLog.log('🚨 MOBILE AUDIO FAILED:');
                                DebugLog.log('Error name: ' + e.name);
                                DebugLog.log('Error message: ' + e.message);
                                DebugLog.log('Error code: ' + (e.code || 'none'));
                                DebugLog.log('🔄 Trying synthesis fallback...');
                                Speech.speakWithSynthesis(State.questions[0]);
                            });
                        } else {
                            DebugLog.log('🚨 No play promise returned!');
                        }
                    }, 3000);
                }
                
                // Continue with original timing for visual effects
                setTimeout(function() {
                    try {
                        if (document.documentElement.requestFullscreen) {
                            DebugLog.log('Requesting fullscreen...');
                            document.documentElement.requestFullscreen();
                        } else if (document.documentElement.webkitRequestFullscreen) {
                            DebugLog.log('Requesting webkit fullscreen...');
                            document.documentElement.webkitRequestFullscreen();
                        } else if (document.documentElement.mozRequestFullScreen) {
                            DebugLog.log('Requesting moz fullscreen...');
                            document.documentElement.mozRequestFullScreen();
                        }
                    } catch (e) {
                        DebugLog.log('Fullscreen request failed: ' + e.message);
                    }
                    
                    UI.hideElement('preInitOverlay');
                    UI.showElement('initOverlay');
                    
                    SG1.startInitialization();
                }, 300);
            },

            startInitialization: function() {
                DebugLog.log('Starting logo animation sequence');
                
                var logo = document.querySelector('.init-logo');
                var status = UI.element('statusText');
                
                if (status) status.textContent = 'Audio system ready. Loading voice...';
                
                if (logo) {
                    logo.style.opacity = '0';
                    logo.style.animation = 'none';
                    logo.style.transform = 'translate(-50%, -50%) scale(0.8)';
                    
                    setTimeout(function() {
                        if (status) {
                            status.textContent = 'Voice system online. Starting sequence...';
                            // Fade out after 2 seconds
                            setTimeout(function() {
                                status.style.transition = 'opacity 1s ease-out';
                                status.style.opacity = '0';
                            }, 2000);
                        }
                        
                        DebugLog.log('Starting SG1 logo animation');
                        logo.style.animation = 'sg1LogoFade 13s ease-in-out forwards';
                        
                        // Backup visibility check
                        setTimeout(function() {
                            if (logo.style.opacity === '0') {
                                DebugLog.log('Logo backup: forcing visibility');
                                logo.style.opacity = '1';
                                logo.style.transform = 'translate(-50%, -50%) scale(1)';
                                
                                setTimeout(function() {
                                    logo.style.opacity = '0';
                                }, 8000);
                            }
                        }, 3000);
                        
                        setTimeout(function() {
                            logo.style.opacity = '0';
                            logo.style.display = 'none';
                        }, 12000);
                        
                    }, 1000);
                } else {
                    DebugLog.log('ERROR: Logo element not found');
                }
                
                setTimeout(function() {
                    if (status) status.textContent = 'Loading neural interface...';
                    DebugLog.log('Showing DNA visualizer');
                    UI.showElement('visualizer');
                    // Gentle fade in DNA
                    var visualizer = UI.element('visualizer');
                    if (visualizer) {
                        visualizer.style.opacity = '0';
                        visualizer.style.transition = 'opacity 4s ease-in';
                        setTimeout(function() {
                            visualizer.style.opacity = '1';
                        }, 100);
                    }
                }, 14000); // DNA appears at 14s (6s after logo ends at 8s - no overlap)
                
                setTimeout(function() {
                    if (status) status.textContent = 'Ready to begin...';
                    UI.hideElement('initOverlay');
                    setTimeout(function() {
                        Conversation.startQ1();
                    }, 500);
                }, 17000); // Voice starts at 17s (back to original timing)
            },

            init: function() {
                DebugLog.init();
                DebugLog.log('=== SG1 SYSTEM INIT ===');
                
                Speech.loadVoices();
                setTimeout(function() {
                    Speech.loadVoices();
                }, 1000);
                if (State.synthesis.onvoiceschanged !== undefined) {
                    State.synthesis.onvoiceschanged = function() {
                        Speech.loadVoices();
                    };
                }
                
                DebugLog.log('SG1 System ready');
            }
        };

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                SG1.init();
            });
        } else {
            SG1.init();
        }

        // Global error handler
        window.onerror = function(message, source, lineno, colno, error) {
            DebugLog.log('ERROR: ' + message + ' at line ' + lineno);
            return false;
        };
//# sourceURL=SG1-working.html
</script>
</body>
</html>